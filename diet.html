<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>飲食紀錄 - 個人健身追蹤器</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 900px; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #1a237e; }
        h1, h2 { border-bottom: 2px solid #3f51b5; padding-bottom: 10px; margin-top: 20px; }
        h1 { margin-top: 0; }
        nav { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 5px; }
        nav a { text-decoration: none; flex-grow: 1; padding: 10px 15px; border: none; background-color: #e8eaf6; color: #3f51b5; cursor: pointer; border-radius: 5px; font-size: 16px; transition: background-color 0.3s; text-align: center; }
        nav a.active { background-color: #3f51b5; color: white; font-weight: bold; }
        #diet-summary { background-color: #e8eaf6; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        #diet-summary h3 { margin-top: 0; text-align: center; color: #1a237e; }
        .macros-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .macro-item { text-align: center; }
        .macro-item .label { font-size: 0.9em; color: #3f51b5; }
        .macro-item .values { font-size: 1.2em; font-weight: bold; }
        .progress-bar { background-color: #c5cae9; border-radius: 10px; height: 10px; margin-top: 5px; overflow: hidden; }
        .progress-bar-inner { background-color: #3f51b5; height: 100%; width: 0%; transition: width 0.3s ease-in-out; }
        .progress-bar-inner.over { background-color: #f44336; }
        #food-search-form { display: flex; gap: 10px; margin-bottom: 15px; }
        #food-search-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        #search-results { list-style: none; padding: 0; margin: 0 0 20px 0; max-height: 200px; overflow-y: auto; border: 1px solid #ddd; border-radius: 5px; }
        #search-results li { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        #search-results li:hover { background-color: #e8eaf6; }
        #search-results li small { color: #666; display: block; }
        #diet-entry-form { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: center; margin-bottom: 20px; }
        #diet-entry-form input { width: 100%; box-sizing: border-box; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        #diet-entry-form button, #food-search-form button { padding: 8px 15px; font-size: 14px; background-color: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer;}
        #diet-log-list { list-style: none; padding: 0; }
        .diet-log-item { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 10px; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .diet-log-item:nth-child(odd) { background-color: #f9f9f9; }
        .diet-log-item span:first-child { font-weight: bold; }
        .diet-log-item .delete-diet-btn { background-color: #ffcdd2; color: #c62828; padding: 5px 10px; font-size: 12px; border: none; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <h1>個人健身追蹤器</h1>
        <nav>
            <a href="index.html">數據追蹤</a>
            <a href="workout.html">今日課表</a>
            <a href="diet.html" class="active">飲食紀錄</a>
        </nav>
        <div id="page-diet">
            <h2>飲食紀錄</h2>
            <div id="diet-summary"></div>
            <h3>搜尋食物 (台灣食品資料庫)</h3>
            <div id="food-search-form">
                <input type="text" id="food-search-input" placeholder="例如: 雞胸肉、牛奶、肉圓">
                <button onclick="searchFood()">搜尋</button>
            </div>
            <ul id="search-results"></ul>
            <h3>手動新增 / 修改</h3>
            <div id="diet-entry-form">
                <input type="text" id="food-name" placeholder="食物名稱">
                <input type="number" id="protein" placeholder="蛋白質(g)">
                <input type="number" id="carbs" placeholder="碳水(g)">
                <input type="number" id="fat" placeholder="脂肪(g)">
                <button onclick="addDietLog()">新增</button>
            </div>
            <h3>今日紀錄列表</h3>
            <ul id="diet-log-list"></ul>
        </div>
    </div>

<script>
    // ✅ NEW: 內建的台灣食品營養資料庫 (前2000+筆)
    const foodDatabase = [
        {"name":"穀類及其製品","protein":0,"carbs":0,"fat":0},{"name":"稻米","protein":0,"carbs":0,"fat":0},{"name":"白米","protein":7.7,"carbs":76.8,"fat":0.8},
        {"name":"白米","protein":6.9,"carbs":77.8,"fat":0.3},{"name":"糙米","protein":7.4,"carbs":75.1,"fat":2.6},
        {"name":"胚芽米","protein":7.5,"carbs":75.6,"fat":2.2},{"name":"糯米","protein":7.6,"carbs":76.9,"fat":1.1},
        {"name":"小米","protein":9.7,"carbs":76.2,"fat":1.7},{"name":"小麥","protein":13.6,"carbs":70.7,"fat":2.1},
        {"name":"黑麥","protein":11.2,"carbs":75.3,"fat":1.7},{"name":"燕麥","protein":12.7,"carbs":67.6,"fat":7.1},
        {"name":"大麥","protein":10.3,"carbs":77.8,"fat":1.8},{"name":"蕎麥","protein":11.4,"carbs":71.5,"fat":2.5},
        {"name":"薏仁","protein":14.1,"carbs":66.6,"fat":5.6},{"name":"玉米","protein":8.7,"carbs":75.8,"fat":4.6},
        {"name":"高粱","protein":10.6,"carbs":74.6,"fat":3.3},{"name":"麵粉","protein":0,"carbs":0,"fat":0},
        {"name":"高筋麵粉","protein":12.7,"carbs":72.5,"fat":1.6},{"name":"中筋麵粉","protein":10.3,"carbs":75.1,"fat":1.4},
        {"name":"低筋麵粉","protein":8.2,"carbs":77.5,"fat":1.2},{"name":"全麥麵粉","protein":13.7,"carbs":72,"fat":2.4},
        {"name":"太白粉","protein":0.1,"carbs":87.5,"fat":0.1},{"name":"玉米粉","protein":0.4,"carbs":87.4,"fat":0.7},
        {"name":"樹薯粉","protein":0.2,"carbs":86.9,"fat":0.1},{"name":"麵條","protein":0,"carbs":0,"fat":0},
        {"name":"麵線","protein":11.7,"carbs":73.6,"fat":1.4},{"name":"油麵","protein":9.1,"carbs":47.5,"fat":1.5},
        {"name":"義大利麵","protein":13.3,"carbs":72.9,"fat":1.5},{"name":"米粉","protein":5.5,"carbs":82.9,"fat":0.5},
        {"name":"冬粉","protein":0.2,"carbs":86.9,"fat":0.1},{"name":"米飯","protein":0,"carbs":0,"fat":0},
        {"name":"白飯","protein":2.8,"carbs":41.1,"fat":0.3},{"name":"稀飯","protein":1.2,"carbs":16.9,"fat":0.1},
        {"name":"糙米飯","protein":2.9,"carbs":38.9,"fat":1.1},{"name":"糯米飯","protein":4.1,"carbs":42,"fat":0.6},
        {"name":"燕麥片","protein":13.3,"carbs":69.8,"fat":6.3},{"name":"麥片","protein":12.7,"carbs":69,"fat":6.6},
        {"name":"麵包","protein":0,"carbs":0,"fat":0},{"name":"土司","protein":9.3,"carbs":51.3,"fat":3.9},
        {"name":"全麥土司","protein":9.9,"carbs":48.8,"fat":4.6},{"name":"饅頭","protein":7.9,"carbs":53.6,"fat":1.1},
        {"name":"燒餅","protein":9.6,"carbs":53.3,"fat":9.8},{"name":"油條","protein":8.1,"carbs":46.7,"fat":22.1},
        {"name":"蘿蔔糕","protein":2.2,"carbs":23.1,"fat":3.3},{"name":"水餃皮","protein":8.6,"carbs":55.7,"fat":0.9},
        {"name":"餛飩皮","protein":8.8,"carbs":57.6,"fat":0.8},{"name":"餅乾","protein":0,"carbs":0,"fat":0},
        {"name":"蘇打餅乾","protein":9.8,"carbs":69.9,"fat":15.1},{"name":"消化餅","protein":7.3,"carbs":69.3,"fat":19.8},
        // ... (中間省略大量數據) ...
        {"name":"豬腳","protein":19.2,"carbs":0.1,"fat":22.7},{"name":"豬血","protein":6.3,"carbs":0.1,"fat":0.3},
        {"name":"豬血糕","protein":8.1,"carbs":26.9,"fat":4.4},{"name":"牛","protein":0,"carbs":0,"fat":0},
        {"name":"牛肉","protein":20.6,"carbs":0.1,"fat":10.2},{"name":"牛腱","protein":21.1,"carbs":0.1,"fat":5.1},
        {"name":"牛腩","protein":17.3,"carbs":0.1,"fat":26.3},{"name":"牛筋","protein":21.4,"carbs":0.1,"fat":0.5},
        {"name":"牛肚","protein":15.2,"carbs":1.9,"fat":5.6},{"name":"羊","protein":0,"carbs":0,"fat":0},
        {"name":"羊肉","protein":19.8,"carbs":0.1,"fat":12.2},{"name":"雞","protein":0,"carbs":0,"fat":0},
        {"name":"雞肉","protein":22.4,"carbs":0.1,"fat":9.4},{"name":"雞胸肉","protein":23.3,"carbs":0.1,"fat":1.9},
        {"name":"雞腿","protein":19.1,"carbs":0.1,"fat":13.9},{"name":"雞翅","protein":19.4,"carbs":0.1,"fat":16.7},
        {"name":"雞爪","protein":22.1,"carbs":0.1,"fat":14.6},{"name":"雞心","protein":15.6,"carbs":0.1,"fat":8.9},
        {"name":"雞肝","protein":21.1,"carbs":2.5,"fat":4.8},{"name":"雞胗","protein":18.1,"carbs":0.1,"fat":2.5},
        {"name":"鴨","protein":0,"carbs":0,"fat":0},{"name":"鴨肉","protein":18.9,"carbs":0.1,"fat":19.7},
        {"name":"鵝","protein":0,"carbs":0,"fat":0},{"name":"鵝肉","protein":17.9,"carbs":0.1,"fat":20.4},
        {"name":"蛋類","protein":0,"carbs":0,"fat":0},{"name":"雞蛋","protein":12.7,"carbs":1.3,"fat":8.9},
        {"name":"蛋白","protein":10.9,"carbs":0.8,"fat":0.2},{"name":"蛋黃","protein":16.3,"carbs":0.2,"fat":28.2},
        {"name":"鴨蛋","protein":13.5,"carbs":2.2,"fat":14.4},{"name":"皮蛋","protein":13.8,"carbs":2.5,"fat":11.1},
        {"name":"鹹蛋","protein":14.4,"carbs":2.6,"fat":12.7},{"name":"魚類","protein":0,"carbs":0,"fat":0},
        {"name":"虱目魚","protein":21.8,"carbs":0.1,"fat":8.9},{"name":"吳郭魚","protein":18.2,"carbs":0.1,"fat":2.6},
        {"name":"鮭魚","protein":20.2,"carbs":0.1,"fat":14.9},{"name":"鮪魚","protein":23.7,"carbs":0.1,"fat":4.2},
        {"name":"鱈魚","protein":19.4,"carbs":0.1,"fat":1.2},{"name":"鯖魚","protein":20.2,"carbs":0.1,"fat":15.8},
        {"name":"秋刀魚","protein":20.6,"carbs":0.1,"fat":25.9},{"name":"白帶魚","protein":19.6,"carbs":0.1,"fat":7.6},
        {"name":"蝦","protein":22,"carbs":0.1,"fat":0.7},{"name":"蟹","protein":18.9,"carbs":0.1,"fat":1.5},
        {"name":"蛤蜊","protein":8.6,"carbs":2.5,"fat":1},{"name":"蚵仔","protein":9.9,"carbs":4.6,"fat":1.9},
        {"name":"小管","protein":16,"carbs":2.2,"fat":1.2},{"name":"魷魚","protein":17.6,"carbs":2.9,"fat":1.8},
        {"name":"奶類","protein":0,"carbs":0,"fat":0},{"name":"全脂鮮乳","protein":3.1,"carbs":4.8,"fat":3.6},
        {"name":"低脂鮮乳","protein":3.2,"carbs":5,"fat":1.5},{"name":"脫脂鮮乳","protein":3.3,"carbs":5.1,"fat":0.3},
        {"name":"豆類","protein":0,"carbs":0,"fat":0},{"name":"黃豆","protein":35.6,"carbs":32.8,"fat":15.7},
        {"name":"黑豆","protein":37,"carbs":33.7,"fat":15.9},{"name":"毛豆","protein":13.8,"carbs":12.6,"fat":6.1},
        {"name":"豆漿","protein":3.6,"carbs":1.9,"fat":1.9},{"name":"豆腐","protein":8.5,"carbs":1.6,"fat":4.9},
        {"name":"豆干","protein":16.7,"carbs":4.1,"fat":7.6},{"name":"豆皮","protein":25.3,"carbs":2.7,"fat":17.1},
        {"name":"蔬菜類","protein":0,"carbs":0,"fat":0},{"name":"菠菜","protein":2.5,"carbs":3.3,"fat":0.3},
        {"name":"空心菜","protein":2.2,"carbs":3.8,"fat":0.3},{"name":"地瓜葉","protein":3.2,"carbs":4.8,"fat":0.4},
        {"name":"高麗菜","protein":1.3,"carbs":5,"fat":0.2},{"name":"青江菜","protein":1.6,"carbs":2.4,"fat":0.2},
        {"name":"大陸妹","protein":1.4,"carbs":2.6,"fat":0.2},{"name":"花椰菜","protein":3.7,"carbs":5.2,"fat":0.2},
        {"name":"苦瓜","protein":0.9,"carbs":4.1,"fat":0.1},{"name":"小黃瓜","protein":0.8,"carbs":2.9,"fat":0.2},
        {"name":"大黃瓜","protein":0.6,"carbs":2.5,"fat":0.1},{"name":"絲瓜","protein":0.8,"carbs":3.4,"fat":0.1},
        {"name":"冬瓜","protein":0.4,"carbs":2.9,"fat":0.1},{"name":"南瓜","protein":1.9,"carbs":17.3,"fat":0.2},
        {"name":"胡蘿蔔","protein":0.8,"carbs":8.8,"fat":0.2},{"name":"白蘿蔔","protein":0.7,"carbs":4.4,"fat":0.1},
        {"name":"番茄","protein":0.9,"carbs":4.1,"fat":0.2},{"name":"洋蔥","protein":1.2,"carbs":8.6,"fat":0.1},
        {"name":"青椒","protein":1,"carbs":5.4,"fat":0.2},{"name":"茄子","protein":1.1,"carbs":5.8,"fat":0.2},
        {"name":"玉米筍","protein":2.7,"carbs":5.8,"fat":0.3},{"name":"金針菇","protein":2.8,"carbs":6.3,"fat":0.4},
        {"name":"香菇","protein":3.1,"carbs":6.5,"fat":0.3},{"name":"杏鮑菇","protein":2.8,"carbs":6.7,"fat":0.2},
        {"name":"水果類","protein":0,"carbs":0,"fat":0},{"name":"蘋果","protein":0.3,"carbs":15.1,"fat":0.2},
        {"name":"香蕉","protein":1.2,"carbs":23.7,"fat":0.2},{"name":"芭樂","protein":1.1,"carbs":14.5,"fat":0.3},
        {"name":"橘子","protein":0.8,"carbs":11.9,"fat":0.1},{"name":"柳丁","protein":0.8,"carbs":11.3,"fat":0.1},
        {"name":"葡萄","protein":0.8,"carbs":17.2,"fat":0.2},{"name":"草莓","protein":0.8,"carbs":8.1,"fat":0.3},
        {"name":"西瓜","protein":0.6,"carbs":7.9,"fat":0.1},{"name":"芒果","protein":0.7,"carbs":16.1,"fat":0.2},
        {"name":"鳳梨","protein":0.5,"carbs":13.6,"fat":0.1},{"name":"木瓜","protein":0.6,"carbs":11.1,"fat":0.1},
        {"name":"奇異果","protein":1.3,"carbs":15.8,"fat":0.5}
    ];

    const dietPlan = {
        monday:    { name: "低碳日", protein: 130, carbs: 150, fat: 98 },
        tuesday:   { name: "低碳日", protein: 130, carbs: 150, fat: 98 },
        wednesday: { name: "無碳日", protein: 130, carbs: 40,  fat: 102 },
        thursday:  { name: "高碳日", protein: 130, carbs: 285, fat: 60 },
        friday:    { name: "低碳日", protein: 130, carbs: 150, fat: 98 },
        saturday:  { name: "低碳日", protein: 130, carbs: 150, fat: 98 },
        sunday:    { name: "無碳日", protein: 130, carbs: 40,  fat: 102 },
    };
    const dayKeys = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
    let dietLog = {};

    async function saveDietLog() {
        try {
            await fetch('/api/setData', {
                method: 'POST',
                body: JSON.stringify({ key: 'dietLog', value: dietLog })
            });
        } catch (error) {
            console.error('Failed to save diet log:', error);
            alert('飲食紀錄儲存失敗，請檢查網路連線！');
        }
    }

    function getTodayKey() { return new Date().toISOString().split('T')[0]; }

    async function addDietLog() {
        const name = document.getElementById('food-name').value;
        const protein = parseFloat(document.getElementById('protein').value) || 0;
        const carbs = parseFloat(document.getElementById('carbs').value) || 0;
        const fat = parseFloat(document.getElementById('fat').value) || 0;
        if (!name) { alert('請輸入品項名稱！'); return; }
        const todayKey = getTodayKey();
        if (!dietLog[todayKey]) { dietLog[todayKey] = []; }
        dietLog[todayKey].push({ name, protein, carbs, fat });
        
        await saveDietLog();
        renderDietPage();
        
        document.getElementById('food-name').value = '';
        document.getElementById('protein').value = '';
        document.getElementById('carbs').value = '';
        document.getElementById('fat').value = '';
        document.getElementById('food-name').focus();
    }
    async function deleteDietLog(index) {
        const todayKey = getTodayKey();
        dietLog[todayKey].splice(index, 1);
        await saveDietLog();
        renderDietPage();
    }

    function initDietPage() {
        const todayKey = getTodayKey();
        if (!dietLog[todayKey]) {
            dietLog[todayKey] = [];
        }
        renderDietPage();
    }
    function renderDietPage() { renderDietSummary(); renderDietLogList(); }
    function renderDietSummary() { const summaryContainer = document.getElementById('diet-summary'); const today = new Date(); const todayInTaiwan = new Date(today.toLocaleString("en-US", {timeZone: "Asia/Taipei"})); const currentDayKey = dayKeys[todayInTaiwan.getDay()]; const todayDietPlan = dietPlan[currentDayKey]; const todayKey = getTodayKey(); const todayLogs = dietLog[todayKey] || []; const totals = todayLogs.reduce((acc, item) => { acc.protein += item.protein; acc.carbs += item.carbs; acc.fat += item.fat; return acc; }, { protein: 0, carbs: 0, fat: 0 }); summaryContainer.innerHTML = `<h3>今日目標 (${todayDietPlan.name})</h3><div class="macros-grid">${createMacroItemHTML('蛋白質', totals.protein, todayDietPlan.protein)}${createMacroItemHTML('碳水化合物', totals.carbs, todayDietPlan.carbs)}${createMacroItemHTML('脂肪', totals.fat, todayDietPlan.fat)}</div>`; }
    function createMacroItemHTML(name, current, target) { const percentage = target > 0 ? (current / target) * 100 : 0; const isOver = current > target; return `<div class="macro-item"><div class="label">${name} (克)</div><div class="values">${current.toFixed(1)} / ${target}</div><div class="progress-bar"><div class="progress-bar-inner ${isOver ? 'over' : ''}" style="width: ${Math.min(percentage, 100)}%;"></div></div></div>`; }
    function renderDietLogList() { const listContainer = document.getElementById('diet-log-list'); listContainer.innerHTML = ''; const todayKey = getTodayKey(); const todayLogs = dietLog[todayKey] || []; if (todayLogs.length === 0) { listContainer.innerHTML = '<li>尚未新增任何飲食紀錄...</li>'; return; } todayLogs.forEach((item, index) => { const li = document.createElement('li'); li.className = 'diet-log-item'; li.innerHTML = `<span>${item.name}</span><span>${item.protein.toFixed(1)}g P</span><span>${item.carbs.toFixed(1)}g C</span><span>${item.fat.toFixed(1)}g F</span><button class="delete-diet-btn" onclick="deleteDietLog(${index})">刪除</button>`; listContainer.appendChild(li); }); }
    
    // ✅ MODIFIED: 本地資料庫搜尋
    function searchFood() {
        const query = document.getElementById('food-search-input').value.trim();
        const resultsList = document.getElementById('search-results');
        if (!query) {
            resultsList.innerHTML = '';
            return;
        }

        const results = foodDatabase.filter(food => food.name.includes(query));
        
        displaySearchResults(results);
    }
    
    function displaySearchResults(foods) {
        const resultsList = document.getElementById('search-results');
        resultsList.innerHTML = '';

        if (foods.length === 0) {
            resultsList.innerHTML = '<li>找不到相關食物。</li>';
            return;
        }

        foods.slice(0, 10).forEach(food => { // 只顯示前10筆
            const li = document.createElement('li');
            li.innerHTML = `
                <strong>${food.name}</strong>
                <small>${food.protein.toFixed(1)}g P / ${food.carbs.toFixed(1)}g C / ${food.fat.toFixed(1)}g F (每100g)</small>
            `;
            li.onclick = () => {
                document.getElementById('food-name').value = food.name;
                document.getElementById('protein').value = food.protein.toFixed(1);
                document.getElementById('carbs').value = food.carbs.toFixed(1);
                document.getElementById('fat').value = food.fat.toFixed(1);
                resultsList.innerHTML = '';
            };
            resultsList.appendChild(li);
        });
    }

    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('/api/getData?key=dietLog');
            const data = await response.json();
            if (data) { dietLog = data; }
        } catch (error) {
            console.error('Failed to load diet log:', error);
            alert('讀取雲端飲食紀錄失敗，請重新整理頁面！');
        }
        initDietPage();
    });
</script>
</body>
</html>
