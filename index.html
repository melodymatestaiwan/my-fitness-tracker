<script>
    const CHALLENGE_TOTAL_DAYS = 100;
    const CHALLENGE_START_DATE = new Date('2025-10-20T00:00:00'); // 這是您上次提供的起始日期
    let myCharts = {};

    function getFormattedDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // 初始化日期輸入欄位為今天
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('entry-date').value = getFormattedDate(new Date());
        init(); // 確保 DOMContentLoaded 時呼叫 init
    });

    // ---------------------- 資料存取與處理 ----------------------
    function getData() {
        try {
            const data = localStorage.getItem('fitnessData');
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error("Error reading from localStorage:", e);
            return [];
        }
    }

    function saveData(data) {
        try {
            localStorage.setItem('fitnessData', JSON.stringify(data));
        } catch (e) {
            console.error("Error writing to localStorage:", e);
        }
    }

    async function addData() {
        const date = document.getElementById('entry-date').value;
        const time = document.querySelector('input[name="time-of-day"]:checked').value;
        const weight = parseFloat(document.getElementById('weight').value);
        const bodyfat = parseFloat(document.getElementById('bodyfat').value);
        const muscleMass = parseFloat(document.getElementById('muscle-mass').value);

        if (!date || (isNaN(weight) && isNaN(bodyfat) && isNaN(muscleMass))) {
            alert('請至少輸入日期和一項數據！');
            return;
        }

        const newData = {
            date,
            time,
            weight: isNaN(weight) ? null : weight,
            bodyfat: isNaN(bodyfat) ? null : bodyfat,
            muscleMass: isNaN(muscleMass) ? null : muscleMass,
            timestamp: new Date().toISOString()
        };

        let data = getData();
        // 檢查並替換相同日期/時間的舊數據 (可選，但更合理)
        const existingIndex = data.findIndex(item => item.date === date && item.time === time);
        if (existingIndex > -1) {
             // 確保保留舊的 timestamp，或更新 timestamp
             newData.timestamp = data[existingIndex].timestamp;
             data[existingIndex] = newData;
        } else {
             data.push(newData);
        }

        // 按照日期和時間戳排序，確保最新數據在後
        data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        saveData(data);
        alert('紀錄新增成功！');

        // 清空輸入欄位 (保留日期)
        document.getElementById('weight').value = '';
        document.getElementById('bodyfat').value = '';
        document.getElementById('muscle-mass').value = '';

        init(); // 重新載入數據並渲染所有組件
    }

    function deleteData(timestamp) {
        if (!confirm('確定要刪除這筆紀錄嗎？')) return;

        let data = getData();
        const initialLength = data.length;
        data = data.filter(item => item.timestamp !== timestamp);

        if (data.length < initialLength) {
            saveData(data);
            alert('紀錄刪除成功！');
            init(); // 重新載入數據並渲染所有組件
        } else {
            alert('找不到該紀錄。');
        }
    }

    // ---------------------- 數據統計與分組 (已修改) ----------------------

    function aggregateData(data, mode) {
        if (data.length === 0) return { labels: [], morning: {}, evening: {} };

        const groups = {};
        const isDaily = mode === 'daily';

        data.forEach(item => {
            const itemDate = new Date(item.date + 'T00:00:00');
            let groupKey;
            
            if (isDaily) {
                groupKey = item.date;
            } else if (mode === 'weekly') {
                const day = itemDate.getDay(); 
                const diff = itemDate.getDate() - day + (day === 0 ? -6 : 1); 
                const weekStart = new Date(itemDate.setDate(diff));
                groupKey = getFormattedDate(weekStart); 
            } else if (mode === 'monthly') {
                groupKey = `${itemDate.getFullYear()}-${String(itemDate.getMonth() + 1).padStart(2, '0')}-01`;
            }

            if (!groups[groupKey]) {
                groups[groupKey] = {
                    weightM: [], bodyfatM: [], muscleMassM: [],
                    weightE: [], bodyfatE: [], muscleMassE: [],
                };
            }

            const suffix = item.time === 'morning' ? 'M' : 'E';

            if (item.weight !== null) groups[groupKey][`weight${suffix}`].push(item.weight);
            if (item.bodyfat !== null) groups[groupKey][`bodyfat${suffix}`].push(item.bodyfat);
            if (item.muscleMass !== null) groups[groupKey][`muscleMass${suffix}`].push(item.muscleMass);
        });

        const sortedKeys = Object.keys(groups).sort();
        const result = { labels: sortedKeys, morning: {}, evening: {} };
        const getAverage = (arr) => arr.length > 0 ? arr.reduce((a, b) => a + b) / arr.length : null;

        ['weight', 'bodyfat', 'muscleMass'].forEach(key => {
            result.morning[key] = sortedKeys.map(k => getAverage(groups[k][`${key}M`]));
            result.evening[key] = sortedKeys.map(k => getAverage(groups[k][`${key}E`]));
        });

        return result;
    }


    // ---------------------- 圖表渲染 (已修改) ----------------------

    function renderChart(canvasId, title, dataM, dataE, labels, unit, colorM, colorE) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (myCharts[canvasId]) {
            myCharts[canvasId].destroy();
        }

        const mode = document.querySelector('#chart-controls button.active').id.replace('btn-', '');
        let timeUnit = 'day';
        let displayFormat = 'MM-dd';

        if (mode === 'weekly') {
            timeUnit = 'week';
            displayFormat = 'yyyy-MM-dd';
        } else if (mode === 'monthly') {
            timeUnit = 'month';
            displayFormat = 'yyyy-MM';
        }
        
        const datasets = [];

        // 早上數據集
        datasets.push({
            label: `早上 (${unit})`,
            data: dataM,
            borderColor: colorM,
            backgroundColor: `${colorM}40`,
            fill: false,
            tension: 0.2,
            pointRadius: 5,
            borderWidth: 3,
            segment: {
                borderColor: ctx => ctx.p0.parsed.y === null || ctx.p1.parsed.y === null ? 'transparent' : colorM
            }
        });

        // 晚上數據集
        datasets.push({
            label: `晚上 (${unit})`,
            data: dataE,
            borderColor: colorE,
            backgroundColor: `${colorE}40`,
            fill: false,
            tension: 0.2,
            pointRadius: 5,
            borderWidth: 3,
            segment: {
                borderColor: ctx => ctx.p0.parsed.y === null || ctx.p1.parsed.y === null ? 'transparent' : colorE
            }
        });


        myCharts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: datasets
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: timeUnit,
                            tooltipFormat: displayFormat,
                            displayFormats: {
                                [timeUnit]: displayFormat
                            }
                        },
                        title: { display: true, text: '日期' }
                    },
                    y: {
                        title: { display: true, text: unit },
                        beginAtZero: false
                    }
                },
                plugins: {
                    legend: { display: true, position: 'top' },
                    title: { display: true, text: title },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                    // 確保顯示單位
                                    let displayUnit = unit;
                                    if (mode !== 'daily' && label.includes('早上') || label.includes('晚上')) {
                                        displayUnit = '平均' + unit;
                                    }
                                    return label + context.parsed.y.toFixed(1) + ' ' + displayUnit.replace(/\(.*\)/, ''); // 移除括號內的單位
                                }
                                return null;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderAllCharts(mode) {
        document.querySelectorAll('#chart-controls button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${mode}`).classList.add('active');

        const rawData = getData();
        const aggregated = aggregateData(rawData, mode);

        // 體重趨勢 (紅色系)
        renderChart('weightChart', '體重趨勢', aggregated.morning.weight, aggregated.evening.weight, aggregated.labels, '公斤(kg)', '#F44336', '#B71C1C');
        // 體脂趨勢 (藍色系)
        renderChart('bodyfatChart', '體脂趨勢', aggregated.morning.bodyfat, aggregated.evening.bodyfat, aggregated.labels, '百分比(%)', '#2196F3', '#0D47A1');
        // 骨骼肌趨勢 (黃色系)
        renderChart('muscleMassChart', '骨骼肌趨勢', aggregated.morning.muscleMass, aggregated.evening.muscleMass, aggregated.labels, '公斤(kg)', '#FFC107', '#FF8F00');
    }

    // ---------------------- 倒數計時器 ----------------------
    // ... (updateCountdown 函數未修改，保留原樣) ...
    function updateCountdown() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const diffTime = today - CHALLENGE_START_DATE;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        const challengeDayNum = diffDays + 1; // 今天是第幾天

        // 確保起始日不會小於 1
        const currentDay = Math.max(1, challengeDayNum);
        
        const remainingDays = CHALLENGE_TOTAL_DAYS - currentDay;
        const progressPercent = Math.min(100, (currentDay / CHALLENGE_TOTAL_DAYS) * 100);

        let statusText = `目標日期：${CHALLENGE_TOTAL_DAYS} 天減脂挑戰`;
        let daysText = `第 ${currentDay} 天 / 共 ${CHALLENGE_TOTAL_DAYS} 天`;
        if (remainingDays < 0) {
            statusText = `挑戰已於 ${Math.abs(remainingDays)} 天前結束！恭喜完成！`;
            daysText = `共 ${CHALLENGE_TOTAL_DAYS} 天 (已超額 ${Math.abs(remainingDays)} 天)`;
        } else if (remainingDays === 0) {
            statusText = `今天是最後一天！衝刺！`;
        }

        document.getElementById('countdown-container').innerHTML = `
            <h2>${statusText}</h2>
            <div class="progress-track">
                <div class="time-bar" style="width: ${progressPercent}%;"></div>
                <div class="weight-icon" style="left: ${progressPercent}%;">🏋️</div>
            </div>
            <div class="progress-details">
                <span>起始: ${getFormattedDate(CHALLENGE_START_DATE)}</span>
                <span>${daysText}</span>
                <span>剩餘: ${Math.max(0, remainingDays)} 天</span>
            </div>
        `;
    }


    // ---------------------- 原始數據表格 ----------------------
    // ... (renderRawDataTable 函數未修改，保留原樣) ...
    function renderRawDataTable() {
        const data = getData();
        const tbody = document.querySelector('#raw-data-table tbody');
        tbody.innerHTML = ''; // 清空現有內容

        // 倒序顯示，最新紀錄在前
        [...data].reverse().forEach(item => {
            const row = tbody.insertRow();
            
            // 格式化時間 (早上/晚上)
            const timeDisplay = item.time === 'morning' ? '早上' : '晚上';

            row.insertCell().textContent = item.date;
            row.insertCell().textContent = timeDisplay;
            row.insertCell().textContent = item.weight !== null ? item.weight.toFixed(1) : '-';
            row.insertCell().textContent = item.bodyfat !== null ? item.bodyfat.toFixed(1) : '-';
            row.insertCell().textContent = item.muscleMass !== null ? item.muscleMass.toFixed(1) : '-';
            
            const actionCell = row.insertCell();
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = '刪除';
            deleteBtn.onclick = () => deleteData(item.timestamp);
            actionCell.appendChild(deleteBtn);
        });
    }

    // ---------------------- 初始化 ----------------------

    function init() {
        updateCountdown();
        renderRawDataTable();
        // 預設渲染「每日數據」模式
        renderAllCharts('daily');
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
