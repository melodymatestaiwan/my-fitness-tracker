<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數據追蹤 - 個人健身追蹤器</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 900px; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #1a237e; }
        h1, h2 { border-bottom: 2px solid #3f51b5; padding-bottom: 10px; margin-top: 20px; }
        h1 { margin-top: 0; }
        nav a { text-decoration: none; flex-grow: 1; padding: 10px 15px; border: none; background-color: #e8eaf6; color: #3f51b5; cursor: pointer; border-radius: 5px; font-size: 16px; transition: background-color 0.3s; text-align: center; }
        nav a.active { background-color: #3f51b5; color: white; font-weight: bold; }
        #countdown-container { background-color: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 25px; }
        #countdown-container h2 { margin-top: 0; text-align: center; border-bottom: none; padding-bottom: 0; font-size: 1.5em; }
        .progress-track { position: relative; background-color: #e0e0e0; border-radius: 15px; height: 25px; margin-top: 20px; border: 1px solid #ccc; overflow: hidden; }
        .time-bar { background-color: #4caf50; height: 100%; width: 0%; transition: width 0.5s ease-in-out; }
        .weight-icon { position: absolute; top: 50%; left: 0%; transform: translate(-50%, -50%); width: 32px; height: 32px; background-color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: left 0.5s ease-in-out; }
        .progress-details { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.9em; color: #555; padding: 0 5px; flex-wrap: wrap; }
        #data-entry-form { background-color: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .form-row { display: flex; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .form-row:last-child { margin-bottom: 0; }
        .form-row label { font-weight: bold; margin-right: -5px; }
        .form-row input[type="date"], .form-row input[type="number"], .form-row input[type="text"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .form-row input[type="number"] { flex: 1; min-width: 100px; }
        .radio-group { display: flex; align-items: center; gap: 15px; margin-left: 10px; }
        .button-row { justify-content: flex-end; }
        button { padding: 10px 20px; border: none; background-color: #4caf50; color: white; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #45a049; }
        #chart-controls { margin: 20px 0; display: flex; align-items: center; flex-wrap: wrap; }
        #chart-controls button { background-color: #9fa8da; margin-right: 5px; margin-bottom: 5px; }
        #chart-controls button.active { background-color: #5c6bc0; }
        canvas { margin-top: 20px; border-radius: 8px; }
        #raw-data-table-container { margin-top: 30px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; }
        #raw-data-table { width: 100%; border-collapse: collapse; }
        #raw-data-table th, #raw-data-table td { padding: 10px 15px; text-align: left; border-bottom: 1px solid #eee; }
        #raw-data-table th { background-color: #e8eaf6; color: #3f51b5; font-weight: bold; position: sticky; top: 0; z-index: 1; }
        #raw-data-table td button { background-color: #2196f3; margin-right: 5px; padding: 6px 10px; font-size: 12px; }
        #raw-data-table td button.delete-btn { background-color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>個人健身追蹤器</h1>
        <nav>
            <a href="index.html" class="active">數據追蹤</a>
            <a href="workout.html">今日課表</a>
            <a href="diet.html">飲食紀錄</a>
            <a href="share.html">分享與成果</a>
        </nav>
        
        <div id="countdown-container"></div>

        <div id="page-tracker">
            <h2>數據輸入</h2>
            <div id="data-entry-form">
                <div class="form-row">
                    <label for="entry-date">日期:</label>
                    <input type="date" id="entry-date">
                    <div class="radio-group">
                        <input type="radio" id="time-morning" name="time-of-day" value="morning" checked><label for="time-morning">早上</label>
                        <input type="radio" id="time-evening" name="time-of-day" value="evening"><label for="time-evening">晚上</label>
                    </div>
                </div>
                <div class="form-row">
                    <label for="weight">體重(kg):</label><input type="number" id="weight" step="0.1" placeholder="75.5">
                    <label for="bodyfat">體脂(%):</label><input type="number" id="bodyfat" step="0.1" placeholder="18.5">
                    <label for="muscle-mass">骨骼肌(kg):</label><input type="number" id="muscle-mass" step="0.1" placeholder="35.0">
                </div>
                <div class="form-row button-row"><button onclick="addData()">新增紀錄</button></div>
            </div>
            
            <div id="chart-controls">
                <span>檢視模式:</span>
                <button id="btn-daily" class="active" onclick="renderAllCharts('daily')">每日數據</button>
                <button id="btn-weekly" onclick="renderAllCharts('weekly')">每週平均</button>
                <button id="btn-monthly" onclick="renderAllCharts('monthly')">每月平均</button>
            </div>
            <h2>體重趨勢</h2><canvas id="weightChart"></canvas>
            <h2>體脂趨勢</h2><canvas id="bodyfatChart"></canvas>
            <h2>骨骼肌趨勢</h2><canvas id="muscleMassChart"></canvas>
            <h2>原始數據 (RAW Data)</h2>
            <div id="raw-data-table-container">
                <table id="raw-data-table">
                    <thead><tr><th>日期</th><th>時間</th><th>體重(kg)</th><th>體脂(%)</th><th>骨骼肌(kg)</th><th>操作</th></tr></thead>
                    <tbody></tbody
                </table>
            </div>
        </div>
    </div>

<script>
    const CHALLENGE_TOTAL_DAYS = 100;
    const CHALLENGE_START_DATE_STRING = '2025-10-20T00:00:00'; 
    const CHALLENGE_START_DATE = new Date(CHALLENGE_START_DATE_STRING); 
    const START_WEIGHT = 83.1;
    const TARGET_WEIGHT = 75.0;

    let myCharts = {};
    let fitnessData = []; // 全域變數，數據將從雲端載入

    function getFormattedDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }
    
    // ---------------------- 資料存取與處理 (雲端存取) ----------------------
    
    async function getDataFromCloud() {
        try {
            const response = await fetch('/api/getData?key=fitnessData');
            if (!response.ok) throw new Error('Failed to fetch fitnessData');
            const data = await response.json();
            // KV 返回的數據已經是 JSON 格式（物件或陣列）
            return data || []; 
        } catch (e) {
            console.error("Error reading from cloud:", e);
            alert("數據同步失敗，請檢查 Vercel KV 連線。");
            return []; // 返回空陣列以防崩潰
        }
    }

    async function saveDataToCloud() {
        try {
            await fetch('/api/setData', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key: 'fitnessData', value: fitnessData })
            });
        } catch (e) {
            console.error("Error writing to cloud:", e);
            alert('數據儲存失敗！請檢查 Vercel KV 連線。');
        }
    }

    async function addData() {
        const date = document.getElementById('entry-date').value;
        const time = document.querySelector('input[name="time-of-day"]:checked').value;
        const weight = parseFloat(document.getElementById('weight').value);
        const bodyfat = parseFloat(document.getElementById('bodyfat').value);
        const muscleMass = parseFloat(document.getElementById('muscle-mass').value);

        if (!date || (isNaN(weight) && isNaN(bodyfat) && isNaN(muscleMass))) {
            alert('請至少輸入日期和一項數據！');
            return;
        }

        // 數據記憶: 保存本次輸入到 localStorage
        const lastInputs = { weight, bodyfat, muscleMass };
        localStorage.setItem('lastFitnessInputs', JSON.stringify(lastInputs));

        const newData = {
            date,
            time,
            weight: isNaN(weight) ? null : weight,
            bodyfat: isNaN(bodyfat) ? null : bodyfat,
            muscleMass: isNaN(muscleMass) ? null : muscleMass,
            timestamp: new Date().toISOString()
        };

        // 從全域變數 fitnessData 獲取當前數據
        // ✅ 核心修正：使用 date 和 time 組合進行精準查找，避免覆蓋
        const existingIndex = fitnessData.findIndex(item => item.date === date && item.time === time);
        
        if (existingIndex > -1) {
             // 如果找到，更新該筆數據
             newData.timestamp = fitnessData[existingIndex].timestamp;
             fitnessData[existingIndex] = newData;
        } else {
             // 如果沒找到，新增數據
             fitnessData.push(newData);
        }

        // 排序，確保圖表正確
        fitnessData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        await saveDataToCloud(); // 儲存到雲端
        alert('紀錄新增成功！');

        await init(); // 重新載入數據並渲染所有組件
    }

    async function deleteData(timestamp) {
        if (!confirm('確定要刪除這筆紀錄嗎？')) return;

        const initialLength = fitnessData.length;
        // 使用 timestamp 進行精確刪除
        const updatedData = fitnessData.filter(item => item.timestamp !== timestamp);
        fitnessData = updatedData;

        if (fitnessData.length < initialLength) {
            await saveDataToCloud(); // 儲存到雲端
            alert('紀錄刪除成功！');
            await init(); 
        } else {
            alert('找不到該紀錄。');
        }
    }
    
    async function editRawData(timestamp) {
        const entry = fitnessData.find(d => d.timestamp === timestamp);
        if (!entry) { alert("找不到該紀錄"); return; }
        
        const newWeight = prompt("請輸入新的體重 (kg):", entry.weight);
        const newBodyfat = prompt("請輸入新的體脂 (%):", entry.bodyfat);
        const newMuscleMass = prompt("請輸入新的骨骼肌 (kg):", entry.muscleMass);
        
        const weight = parseFloat(newWeight);
        const bodyfat = parseFloat(newBodyfat);
        const muscleMass = parseFloat(newMuscleMass);

        if (isNaN(weight) || isNaN(bodyfat) || isNaN(muscleMass)) {
            alert("輸入無效，操作已取消。");
            return;
        }

        entry.weight = weight;
        entry.bodyfat = bodyfat;
        entry.muscleMass = muscleMass;
        
        await saveDataToCloud(); // 儲存到雲端
        await init();
    }

    // ---------------------- 數據統計與分組 ----------------------

    function aggregateData(data, mode) {
        if (data.length === 0) return { labels: [], morning: {}, evening: {} };

        const groups = {};

        data.forEach(item => {
            const itemDate = new Date(item.date + 'T00:00:00');
            let groupKey;
            
            if (mode === 'daily') {
                groupKey = item.date;
            } else if (mode === 'weekly') {
                const day = itemDate.getDay(); 
                const diff = itemDate.getDate() - day + (day === 0 ? -6 : 1); 
                const weekStart = new Date(itemDate.setDate(diff));
                groupKey = getFormattedDate(weekStart); 
            } else if (mode === 'monthly') {
                groupKey = `${itemDate.getFullYear()}-${String(itemDate.getMonth() + 1).padStart(2, '0')}-01`;
            }

            if (!groups[groupKey]) {
                groups[groupKey] = {
                    weightM: [], bodyfatM: [], muscleMassM: [],
                    weightE: [], bodyfatE: [], muscleMassE: [],
                };
            }

            const suffix = item.time === 'morning' ? 'M' : 'E';

            if (item.weight !== null) groups[groupKey][`weight${suffix}`].push(item.weight);
            if (item.bodyfat !== null) groups[groupKey][`bodyfat${suffix}`].push(item.bodyfat);
            if (item.muscleMass !== null) groups[groupKey][`muscleMass${suffix}`].push(item.muscleMass);
        });

        const sortedKeys = Object.keys(groups).sort();
        const result = { labels: sortedKeys, morning: {}, evening: {} };
        const getAverage = (arr) => arr.length > 0 ? arr.reduce((a, b) => a + b) / arr.length : null;

        ['weight', 'bodyfat', 'muscleMass'].forEach(key => {
            result.morning[key] = sortedKeys.map(k => getAverage(groups[k][`${key}M`]));
            result.evening[key] = sortedKeys.map(k => getAverage(groups[k][`${key}E`]));
        });

        return result;
    }


    // ---------------------- 圖表渲染 ----------------------

    function createChart(canvasId, yAxisLabel, morningData, eveningData, labels, timeUnit) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        ctx.canvas.style.backgroundColor = '#E6F5E6'; // 淺粉綠色背景

        if (myCharts[canvasId]) {
            myCharts[canvasId].destroy();
        }
        
        // 修正顏色：早上(白色點+深灰色線)，晚上(黑色點+黑色線)
        const MORNING_COLOR = 'rgba(0, 0, 0, 0.6)'; // 深灰色線
        const EVENING_COLOR = 'rgba(0, 0, 0, 1)';   // 黑色線/點

        myCharts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `早上 (${yAxisLabel.split(' ')[0]})`,
                    data: morningData,
                    pointBackgroundColor: 'rgba(255, 255, 255, 1)', // ✅ 白色點
                    pointBorderColor: 'rgba(0, 0, 0, 1)',         // ✅ 黑色邊框
                    pointBorderWidth: 1.5,
                    borderColor: MORNING_COLOR,                   // ✅ 深灰色線
                    tension: 0.1,
                    segment: { borderColor: ctx => ctx.p0.parsed.y === null || ctx.p1.parsed.y === null ? 'transparent' : MORNING_COLOR }
                }, {
                    label: `晚上 (${yAxisLabel.split(' ')[0]})`,
                    data: eveningData,
                    borderColor: EVENING_COLOR,                   // ✅ 黑色線
                    backgroundColor: 'rgba(0, 0, 0, 0.1)',
                    pointBackgroundColor: EVENING_COLOR,          // ✅ 黑色點
                    tension: 0.1,
                    segment: { borderColor: ctx => ctx.p0.parsed.y === null || ctx.p1.parsed.y === null ? 'transparent' : EVENING_COLOR }
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: timeUnit, tooltipFormat: 'yyyy-MM-dd' },
                        title: { display: true, text: '日期' }
                    },
                    y: {
                        position: 'left',
                        title: { display: true, text: yAxisLabel }
                    }
                }
            }
        });
        return myCharts[canvasId];
    }

    function renderAllCharts(mode) {
        document.querySelectorAll('#chart-controls button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${mode}`).classList.add('active');

        // 銷毀舊圖表實例
        if (myCharts['weightChart']) myCharts['weightChart'].destroy();
        if (myCharts['bodyfatChart']) myCharts['bodyfatChart'].destroy();
        if (myCharts['muscleMassChart']) myCharts['muscleMassChart'].destroy();

        const rawData = fitnessData; // 從全域變數獲取數據
        const aggregated = aggregateData(rawData, mode);

        // 繪製三個獨立圖表
        myCharts['weightChart'] = createChart('weightChart', '體重 (kg)', aggregated.morning.weight, aggregated.evening.weight, aggregated.labels, mode === 'daily' ? 'day' : (mode === 'weekly' ? 'week' : 'month'));
        myCharts['bodyfatChart'] = createChart('bodyfatChart', '體脂 (%)', aggregated.morning.bodyfat, aggregated.evening.bodyfat, aggregated.labels, mode === 'daily' ? 'day' : (mode === 'weekly' ? 'week' : 'month'));
        myCharts['muscleMassChart'] = createChart('muscleMassChart', '骨骼肌 (kg)', aggregated.morning.muscleMass, aggregated.evening.muscleMass, aggregated.labels, mode === 'daily' ? 'day' : (mode === 'weekly' ? 'week' : 'month'));
    }

    // ---------------------- 倒數計時器 ----------------------

    function updateCountdown() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const start = new Date(CHALLENGE_START_DATE.getTime() - (CHALLENGE_START_DATE.getTimezoneOffset() * 60000));
        start.setHours(0, 0, 0, 0);

        const diffTime = today.getTime() - start.getTime();
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        const challengeDayNum = diffDays + 1; 

        const currentDay = Math.max(1, challengeDayNum);
        const remainingDays = CHALLENGE_TOTAL_DAYS - currentDay;
        const progressPercent = Math.min(100, (currentDay / CHALLENGE_TOTAL_DAYS) * 100);

        // --- 體重進度計算 (用於進度條) ---
        const lastWeight = fitnessData.length > 0 ? fitnessData[fitnessData.length - 1].weight : START_WEIGHT;
        const totalLossNeeded = START_WEIGHT - TARGET_WEIGHT;
        const lossSoFar = START_WEIGHT - lastWeight;
        let weightProgressPercent = 0;
        if (totalLossNeeded > 0) {
            weightProgressPercent = (lossSoFar / totalLossNeeded) * 100;
        } else if (lastWeight <= TARGET_WEIGHT) {
            weightProgressPercent = 100;
        }
        weightProgressPercent = Math.max(0, Math.min(100, weightProgressPercent));

        // --- HTML 內容渲染 ---
        let statusText = `目標日期：${CHALLENGE_TOTAL_DAYS} 天減脂挑戰`;
        let daysText = `第 ${currentDay} 天 / 共 ${CHALLENGE_TOTAL_DAYS} 天`;
        if (remainingDays < 0) {
            statusText = `挑戰已於 ${Math.abs(remainingDays)} 天前結束！恭喜完成！`;
            daysText = `共 ${CHALLENGE_TOTAL_DAYS} 天 (已超額 ${Math.abs(remainingDays)} 天)`;
        } else if (remainingDays === 0) {
            statusText = `今天是最後一天！衝刺！`;
        }

        document.getElementById('countdown-container').innerHTML = `
            <h2>${statusText}</h2>
            <div class="progress-track" data-start="${START_WEIGHT.toFixed(1)}kg" data-target="${TARGET_WEIGHT.toFixed(1)}kg">
                <div class="time-bar" style="width: ${progressPercent}%;"></div>
                <div class="weight-icon" style="left: ${weightProgressPercent}%;">🏋️</div>
            </div>
            <div class="progress-details">
                <span>當前體重: ${lastWeight.toFixed(1)}kg</span>
                <span>${daysText}</span>
                <span>減脂進度: ${lossSoFar.toFixed(1)}kg / ${(START_WEIGHT - TARGET_WEIGHT).toFixed(1)}kg</span>
            </div>
        `;
    }

    // ---------------------- 原始數據表格 ----------------------

    function renderRawDataTable() {
        const data = fitnessData; // 從全域變數獲取數據
        const tbody = document.querySelector('#raw-data-table tbody');
        tbody.innerHTML = '';

        [...data].reverse().forEach(item => {
            const row = tbody.insertRow();
            const timeDisplay = item.time === 'morning' ? '早上' : '晚上';

            row.insertCell().textContent = item.date;
            row.insertCell().textContent = timeDisplay;
            row.insertCell().textContent = item.weight !== null ? item.weight.toFixed(1) : '-';
            row.insertCell().textContent = item.bodyfat !== null ? item.bodyfat.toFixed(1) : '-';
            row.insertCell().textContent = item.muscleMass !== null ? item.muscleMass.toFixed(1) : '-';
            
            const actionCell = row.insertCell();
            const editBtn = document.createElement('button');
            editBtn.textContent = '編輯';
            editBtn.onclick = () => editRawData(item.timestamp);
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = '刪除';
            deleteBtn.onclick = () => deleteData(item.timestamp);
            actionCell.appendChild(editBtn);
            actionCell.appendChild(deleteBtn);
        });
    }

    // ---------------------- 初始化 ----------------------

    async function init() {
        // 1. 從雲端載入數據到全域變數
        fitnessData = await getDataFromCloud();

        // 2. 數據記憶: 載入上次輸入值並填入欄位
        const lastInputs = JSON.parse(localStorage.getItem('lastFitnessInputs'));
        if (lastInputs) {
            document.getElementById('weight').value = lastInputs.weight || '';
            document.getElementById('bodyfat').value = lastInputs.bodyfat || '';
            document.getElementById('muscle-mass').value = lastInputs.muscleMass || '';
        }
        
        document.getElementById('entry-date').value = getFormattedDate(new Date());
        
        // 3. 渲染所有組件
        updateCountdown();
        renderRawDataTable();
        renderAllCharts('daily');
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
