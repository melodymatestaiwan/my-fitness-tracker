<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å¥èº«æŒ‘æˆ°é€²åº¦è¿½è¹¤</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: "Noto Sans TC", sans-serif; margin: 20px; background-color: #f6f8fa; color: #222; }
    h1 { text-align: center; }
    .container { max-width: 800px; margin: auto; }
    .card { background: #fff; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    input, select, button { font-size: 16px; margin: 6px 0; padding: 6px; }
    button { background: #2e86de; color: white; border: none; border-radius: 6px; cursor: pointer; padding: 8px 12px; }
    button:hover { background: #1e6acb; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 6px 8px; text-align: center; }
    th { background: #eee; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”¥ å¥èº«æŒ‘æˆ°é€²åº¦è¿½è¹¤</h1>

    <div id="countdown-container" class="card"></div>

    <div class="card">
      <h2>ğŸ“¥ æ–°å¢ç´€éŒ„</h2>
      <label>æ—¥æœŸï¼š</label><input type="date" id="dateInput"><br>
      <label>æ™‚æ®µï¼š</label>
      <select id="timeInput">
        <option value="æ—©ä¸Š">æ—©ä¸Š</option>
        <option value="ä¸­åˆ">ä¸­åˆ</option>
        <option value="æ™šä¸Š">æ™šä¸Š</option>
      </select><br>
      <label>é«”é‡(kg)ï¼š</label><input type="number" step="0.1" id="weightInput"><br>
      <label>é«”è„‚(%)ï¼š</label><input type="number" step="0.1" id="bodyfatInput"><br>
      <button onclick="addData()">æ–°å¢ç´€éŒ„</button>
    </div>

    <div class="card">
      <h2>ğŸ“Š é«”é‡è¶¨å‹¢</h2>
      <canvas id="weightChart"></canvas>
    </div>

    <div class="card">
      <h2>ğŸ§¾ RAW Data</h2>
      <table id="rawDataTable">
        <thead><tr><th>æ—¥æœŸ</th><th>æ™‚æ®µ</th><th>é«”é‡</th><th>é«”è„‚</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    const CHALLENGE_START_DATE = "2025-10-17";
    const CHALLENGE_TOTAL_DAYS = 100;
    const START_WEIGHT = 83.1;      // ğŸ”§ èµ·å§‹é«”é‡
    const GOAL_WEIGHT = 75.0;       // ğŸ”§ æŒ‘æˆ°ç›®æ¨™

    let fitnessData = [];
    let weightChart;

    async function init() {
      const res = await fetch('/api/getData?key=fitnessData');
      const result = await res.json();
      fitnessData = result?.value ? JSON.parse(result.value) : [];
      renderRawDataTable();
      renderChart();
      updateCountdown();
    }

    async function saveDataToCloud() {
      await fetch('/api/setData', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ key: 'fitnessData', value: fitnessData })
      });
    }

    async function addData() {
      const date = document.getElementById('dateInput').value;
      const time = document.getElementById('timeInput').value;
      const weight = parseFloat(document.getElementById('weightInput').value);
      const bodyfat = parseFloat(document.getElementById('bodyfatInput').value);

      if (!date || !weight) return alert('è«‹è¼¸å…¥æ—¥æœŸèˆ‡é«”é‡');

      const newData = {
        date, time, weight, bodyfat: bodyfat || null,
        timestamp: new Date().toISOString()
      };

      // ğŸ”§ é¿å…åŒæ—¥æœŸåŒæ™‚æ®µé‡è¤‡
      fitnessData = Object.values(
        fitnessData.reduce((acc, item) => {
          const key = `${item.date}-${item.time}`;
          acc[key] = item;
          return acc;
        }, {})
      );
      fitnessData.push(newData);

      // ğŸ”§ æ’åº
      fitnessData.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

      await saveDataToCloud();
      alert('ç´€éŒ„æ–°å¢æˆåŠŸï¼');
      await init();
    }

    function renderRawDataTable() {
      const tbody = document.querySelector('#rawDataTable tbody');
      tbody.innerHTML = '';
      fitnessData.forEach(item => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${item.date}</td>
          <td>${item.time}</td>
          <td>${item.weight.toFixed(1)}</td>
          <td>${item.bodyfat ? item.bodyfat.toFixed(1) : '-'}</td>`;
        tbody.appendChild(tr);
      });
    }

    function renderChart() {
      const ctx = document.getElementById('weightChart').getContext('2d');
      const labels = fitnessData.map(i => `${i.date} ${i.time}`);
      const weights = fitnessData.map(i => i.weight);

      if (weightChart) weightChart.destroy();
      weightChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'é«”é‡(kg)',
            data: weights,
            borderColor: '#2e86de',
            backgroundColor: 'rgba(46,134,222,0.1)',
            fill: true,
            tension: 0.2
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: false },
          }
        }
      });
    }

    // ğŸ”§ å€’æ•¸èˆ‡é«”é‡æŒ‘æˆ°é€²åº¦æ¢
    function updateCountdown() {
      const start = new Date(CHALLENGE_START_DATE);
      const today = new Date();
      const diffDays = Math.floor((today - start) / (1000 * 60 * 60 * 24));
      const dayCount = Math.max(0, Math.min(CHALLENGE_TOTAL_DAYS, diffDays));
      const remain = CHALLENGE_TOTAL_DAYS - dayCount;
      const percent = Math.min(100, (dayCount / CHALLENGE_TOTAL_DAYS) * 100);

      // æ‰¾æœ€æ–°é«”é‡
      const sorted = [...fitnessData].sort((a, b) => b.timestamp - a.timestamp);
      const currentWeight = sorted.length ? sorted[0].weight : START_WEIGHT;

      // é«”é‡é”æˆç‡
      const totalDiff = START_WEIGHT - GOAL_WEIGHT;
      const currentDiff = START_WEIGHT - currentWeight;
      const weightPercent = Math.min(100, Math.max(0, (currentDiff / totalDiff) * 100));

      const container = document.getElementById('countdown-container');
      container.innerHTML = `
        <div style="font-weight:bold;margin-bottom:8px;">ğŸ”¥ ç¬¬ ${dayCount} å¤©ã€€å‰©é¤˜ ${remain} å¤©</div>
        <div style="background:#ddd;border-radius:8px;height:20px;width:100%;">
          <div style="background:#2e86de;width:${percent}%;height:100%;border-radius:8px;"></div>
        </div>
        <div style="margin-top:5px;font-size:14px;color:#333;">æŒ‘æˆ°é€²åº¦ ${percent.toFixed(1)}%</div>

        <div style="margin-top:16px;font-weight:bold;">âš–ï¸ é«”é‡é€²åº¦</div>
        <div style="font-size:14px;margin-bottom:4px;">
          èµ·å§‹ ${START_WEIGHT} kg â†’ ç›®æ¨™ ${GOAL_WEIGHT} kgã€€ç›®å‰ <b>${currentWeight.toFixed(1)} kg</b>
        </div>
        <div style="background:#ddd;border-radius:8px;height:20px;width:100%;">
          <div style="background:#27ae60;width:${weightPercent}%;height:100%;border-radius:8px;"></div>
        </div>
        <div style="margin-top:5px;font-size:14px;color:#333;">
          é«”é‡å·²æ¸› ${currentDiff.toFixed(1)} kgï¼ˆé”æˆç‡ ${weightPercent.toFixed(1)}%ï¼‰
        </div>
      `;
    }

    init();
  </script>
</body>
</html>
