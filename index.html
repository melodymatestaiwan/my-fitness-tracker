<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•¸æ“šè¿½è¹¤ - å€‹äººå¥èº«è¿½è¹¤å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 900px; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #1a237e; }
        h1, h2 { border-bottom: 2px solid #3f51b5; padding-bottom: 10px; margin-top: 20px; }
        h1 { margin-top: 0; }
        nav { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 5px; }
        nav a { text-decoration: none; flex-grow: 1; padding: 10px 15px; border: none; background-color: #e8eaf6; color: #3f51b5; cursor: pointer; border-radius: 5px; font-size: 16px; transition: background-color 0.3s; text-align: center; }
        nav a.active { background-color: #3f51b5; color: white; font-weight: bold; }
        #countdown-container { background-color: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 25px; }
        #countdown-container h2 { margin-top: 0; text-align: center; border-bottom: none; padding-bottom: 0; font-size: 1.5em; }
        .progress-track { position: relative; background-color: #e0e0e0; border-radius: 15px; height: 25px; margin-top: 20px; border: 1px solid #ccc; overflow: hidden; }
        .time-bar { background-color: #4caf50; height: 100%; width: 0%; transition: width 0.5s ease-in-out; }
        .weight-icon { position: absolute; top: 50%; left: 0%; transform: translate(-50%, -50%); width: 32px; height: 32px; background-color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.3); transition: left 0.5s ease-in-out; }
        .progress-details { display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.9em; color: #555; padding: 0 5px; flex-wrap: wrap; }
        #data-entry-form { background-color: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .form-row { display: flex; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .form-row:last-child { margin-bottom: 0; }
        .form-row label { font-weight: bold; margin-right: -5px; }
        .form-row input[type="date"], .form-row input[type="number"], .form-row input[type="text"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .form-row input[type="number"] { flex: 1; min-width: 100px; }
        .radio-group { display: flex; align-items: center; gap: 15px; margin-left: 10px; }
        .button-row { justify-content: flex-end; }
        button { padding: 10px 20px; border: none; background-color: #4caf50; color: white; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #45a049; }
        #chart-controls { margin: 20px 0; display: flex; align-items: center; flex-wrap: wrap; }
        #chart-controls button { background-color: #9fa8da; margin-right: 5px; margin-bottom: 5px; }
        #chart-controls button.active { background-color: #5c6bc0; }
        canvas { margin-top: 20px; border-radius: 8px; }
        #raw-data-table-container { margin-top: 30px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; }
        #raw-data-table { width: 100%; border-collapse: collapse; }
        #raw-data-table th, #raw-data-table td { padding: 10px 15px; text-align: left; border-bottom: 1px solid #eee; }
        #raw-data-table th { background-color: #e8eaf6; color: #3f51b5; font-weight: bold; position: sticky; top: 0; z-index: 1; }
        #raw-data-table td button { background-color: #2196f3; margin-right: 5px; padding: 6px 10px; font-size: 12px; }
        #raw-data-table td button.delete-btn { background-color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>å€‹äººå¥èº«è¿½è¹¤å™¨</h1>
        <nav>
            <a href="index.html" class="active">æ•¸æ“šè¿½è¹¤</a>
            <a href="workout.html">ä»Šæ—¥èª²è¡¨</a>
            <a href="diet.html">é£²é£Ÿç´€éŒ„</a>
            <a href="share.html">åˆ†äº«èˆ‡æˆæœ</a>
        </nav>
        
        <a href="share.html" style="display:block; text-align:center; padding:12px; background-color:#2196f3; color:white; border-radius:8px; text-decoration:none; font-size:18px; font-weight:bold; margin-bottom:20px;">ä¸€éµç”Ÿåœ–</a>
        <div id="countdown-container"></div>

        <div id="page-tracker">
            <h2>æ•¸æ“šè¼¸å…¥</h2>
            <div id="data-entry-form">
                <div class="form-row">
                    <label for="entry-date">æ—¥æœŸ:</label>
                    <input type="date" id="entry-date">
                    <div class="radio-group">
                        <input type="radio" id="time-morning" name="time-of-day" value="morning" checked><label for="time-morning">æ—©ä¸Š</label>
                        <input type="radio" id="time-evening" name="time-of-day" value="evening"><label for="time-evening">æ™šä¸Š</label>
                    </div>
                </div>
                <div class="form-row">
                    <label for="weight">é«”é‡(kg):</label><input type="number" id="weight" step="0.1" placeholder="75.5">
                    <label for="bodyfat">é«”è„‚(%):</label><input type="number" id="bodyfat" step="0.1" placeholder="18.5">
                    <label for="muscle-mass">éª¨éª¼è‚Œ(kg):</label><input type="number" id="muscle-mass" step="0.1" placeholder="35.0">
                </div>
                <div class="form-row button-row"><button onclick="addData()">æ–°å¢ç´€éŒ„</button></div>
            </div>
            
            <div id="chart-controls">
                <span>æª¢è¦–æ¨¡å¼:</span>
                <button id="btn-daily" class="active" onclick="renderAllCharts('daily')">æ¯æ—¥æ•¸æ“š</button>
                <button id="btn-weekly" onclick="renderAllCharts('weekly')">æ¯é€±å¹³å‡</button>
                <button id="btn-monthly" onclick="renderAllCharts('monthly')">æ¯æœˆå¹³å‡</button>
            </div>
            <h2>é«”é‡è¶¨å‹¢</h2><canvas id="weightChart"></canvas>
            <h2>é«”è„‚è¶¨å‹¢</h2><canvas id="bodyfatChart"></canvas>
            <h2>éª¨éª¼è‚Œè¶¨å‹¢</h2><canvas id="muscleMassChart"></canvas>
            <h2>åŸå§‹æ•¸æ“š (RAW Data)</h2>
            <div id="raw-data-table-container">
                <table id="raw-data-table">
                    <thead><tr><th>æ—¥æœŸ</th><th>æ™‚é–“</th><th>é«”é‡(kg)</th><th>é«”è„‚(%)</th><th>éª¨éª¼è‚Œ(kg)</th><th>æ“ä½œ</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    const CHALLENGE_TOTAL_DAYS = 100;
    const CHALLENGE_START_DATE = new Date('2025-10-20T00:00:00'); // é€™æ˜¯æ‚¨ä¸Šæ¬¡æä¾›çš„èµ·å§‹æ—¥æœŸ
    let myCharts = {};

    function getFormattedDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // åˆå§‹åŒ–æ—¥æœŸè¼¸å…¥æ¬„ä½ç‚ºä»Šå¤©
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('entry-date').value = getFormattedDate(new Date());
    });

    // ---------------------- è³‡æ–™å­˜å–èˆ‡è™•ç† ----------------------
    function getData() {
        try {
            const data = localStorage.getItem('fitnessData');
            return data ? JSON.parse(data) : [];
        } catch (e) {
            console.error("Error reading from localStorage:", e);
            return [];
        }
    }

    function saveData(data) {
        try {
            localStorage.setItem('fitnessData', JSON.stringify(data));
        } catch (e) {
            console.error("Error writing to localStorage:", e);
        }
    }

    async function addData() {
        const date = document.getElementById('entry-date').value;
        const time = document.querySelector('input[name="time-of-day"]:checked').value;
        const weight = parseFloat(document.getElementById('weight').value);
        const bodyfat = parseFloat(document.getElementById('bodyfat').value);
        const muscleMass = parseFloat(document.getElementById('muscle-mass').value);

        if (!date || (isNaN(weight) && isNaN(bodyfat) && isNaN(muscleMass))) {
            alert('è«‹è‡³å°‘è¼¸å…¥æ—¥æœŸå’Œä¸€é …æ•¸æ“šï¼');
            return;
        }

        const newData = {
            date,
            time,
            weight: isNaN(weight) ? null : weight,
            bodyfat: isNaN(bodyfat) ? null : bodyfat,
            muscleMass: isNaN(muscleMass) ? null : muscleMass,
            timestamp: new Date().toISOString()
        };

        let data = getData();
        data.push(newData);
        // æŒ‰ç…§æ—¥æœŸå’Œæ™‚é–“æˆ³æ’åºï¼Œç¢ºä¿æœ€æ–°æ•¸æ“šåœ¨å¾Œ
        data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));

        saveData(data);
        alert('ç´€éŒ„æ–°å¢æˆåŠŸï¼');

        // æ¸…ç©ºè¼¸å…¥æ¬„ä½ (ä¿ç•™æ—¥æœŸ)
        document.getElementById('weight').value = '';
        document.getElementById('bodyfat').value = '';
        document.getElementById('muscle-mass').value = '';

        init(); // é‡æ–°è¼‰å…¥æ•¸æ“šä¸¦æ¸²æŸ“æ‰€æœ‰çµ„ä»¶
    }

    function deleteData(timestamp) {
        if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†ç´€éŒ„å—ï¼Ÿ')) return;

        let data = getData();
        const initialLength = data.length;
        data = data.filter(item => item.timestamp !== timestamp);

        if (data.length < initialLength) {
            saveData(data);
            alert('ç´€éŒ„åˆªé™¤æˆåŠŸï¼');
            init(); // é‡æ–°è¼‰å…¥æ•¸æ“šä¸¦æ¸²æŸ“æ‰€æœ‰çµ„ä»¶
        } else {
            alert('æ‰¾ä¸åˆ°è©²ç´€éŒ„ã€‚');
        }
    }

    // ---------------------- æ•¸æ“šçµ±è¨ˆèˆ‡åˆ†çµ„ ----------------------

    function aggregateData(data, mode) {
        if (data.length === 0) return { labels: [], weight: [], bodyfat: [], muscleMass: [] };

        const groups = {};

        data.forEach(item => {
            const itemDate = new Date(item.date + 'T00:00:00');
            let groupKey;

            if (mode === 'daily') {
                groupKey = item.date;
            } else if (mode === 'weekly') {
                const day = itemDate.getDay(); // 0 (Sun) to 6 (Sat)
                // å¾é€±ä¸€ (1) é–‹å§‹è¨ˆç®—é€±æ•¸
                const diff = itemDate.getDate() - day + (day === 0 ? -6 : 1); 
                const weekStart = new Date(itemDate.setDate(diff));
                groupKey = getFormattedDate(weekStart); // ä»¥é€±ä¸€æ—¥æœŸä½œç‚º Key
            } else if (mode === 'monthly') {
                groupKey = `${itemDate.getFullYear()}-${String(itemDate.getMonth() + 1).padStart(2, '0')}-01`;
            }

            if (!groups[groupKey]) {
                groups[groupKey] = {
                    count: 0,
                    weightSum: 0,
                    bodyfatSum: 0,
                    muscleMassSum: 0,
                    weightCount: 0,
                    bodyfatCount: 0,
                    muscleMassCount: 0,
                    label: groupKey
                };
            }
            
            if (item.weight !== null) {
                groups[groupKey].weightSum += item.weight;
                groups[groupKey].weightCount++;
            }
            if (item.bodyfat !== null) {
                groups[groupKey].bodyfatSum += item.bodyfat;
                groups[groupKey].bodyfatCount++;
            }
            if (item.muscleMass !== null) {
                groups[groupKey].muscleMassSum += item.muscleMass;
                groups[groupKey].muscleMassCount++;
            }
        });

        const sortedKeys = Object.keys(groups).sort();
        const result = { labels: [], weight: [], bodyfat: [], muscleMass: [] };

        sortedKeys.forEach(key => {
            const group = groups[key];
            
            result.labels.push(key);
            result.weight.push(group.weightCount > 0 ? group.weightSum / group.weightCount : null);
            result.bodyfat.push(group.bodyfatCount > 0 ? group.bodyfatSum / group.bodyfatCount : null);
            result.muscleMass.push(group.muscleMassCount > 0 ? group.muscleMassSum / group.muscleMassCount : null);
        });

        return result;
    }


    // ---------------------- åœ–è¡¨æ¸²æŸ“ ----------------------

    function renderChart(canvasId, title, data, unit, color) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        if (myCharts[canvasId]) {
            myCharts[canvasId].destroy();
        }

        const mode = document.querySelector('#chart-controls button.active').id.replace('btn-', '');
        let tooltipUnit = unit;
        let timeUnit = 'day';
        let displayFormat = 'MM-dd';

        if (mode === 'weekly') {
            tooltipUnit = 'å¹³å‡' + unit;
            timeUnit = 'week';
            displayFormat = 'yyyy-MM-dd';
        } else if (mode === 'monthly') {
            tooltipUnit = 'å¹³å‡' + unit;
            timeUnit = 'month';
            displayFormat = 'yyyy-MM';
        }

        myCharts[canvasId] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: data.labels,
                datasets: [{
                    label: title,
                    data: data.values,
                    borderColor: color,
                    backgroundColor: `${color}40`,
                    fill: false,
                    tension: 0.2,
                    pointRadius: 5,
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: timeUnit,
                            tooltipFormat: displayFormat,
                            displayFormats: {
                                [timeUnit]: displayFormat
                            }
                        },
                        title: { display: true, text: 'æ—¥æœŸ' }
                    },
                    y: {
                        title: { display: true, text: unit },
                        beginAtZero: false
                    }
                },
                plugins: {
                    legend: { display: false },
                    title: { display: true, text: title },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) { label += ': '; }
                                if (context.parsed.y !== null) {
                                    label += context.parsed.y.toFixed(1) + ' ' + tooltipUnit;
                                }
                                return label;
                            }
                        }
                    }
                }
            }
        });
    }

    function renderAllCharts(mode) {
        document.querySelectorAll('#chart-controls button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${mode}`).classList.add('active');

        const rawData = getData();
        const aggregated = aggregateData(rawData, mode);

        renderChart('weightChart', 'é«”é‡è¶¨å‹¢', { labels: aggregated.labels, values: aggregated.weight }, 'å…¬æ–¤(kg)', '#FF6384');
        renderChart('bodyfatChart', 'é«”è„‚è¶¨å‹¢', { labels: aggregated.labels, values: aggregated.bodyfat }, 'ç™¾åˆ†æ¯”(%)', '#36A2EB');
        renderChart('muscleMassChart', 'éª¨éª¼è‚Œè¶¨å‹¢', { labels: aggregated.labels, values: aggregated.muscleMass }, 'å…¬æ–¤(kg)', '#FFCD56');
    }

    // ---------------------- å€’æ•¸è¨ˆæ™‚å™¨ ----------------------

    function updateCountdown() {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const diffTime = today - CHALLENGE_START_DATE;
        const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
        const challengeDayNum = diffDays + 1; // ä»Šå¤©æ˜¯ç¬¬å¹¾å¤©

        // ç¢ºä¿èµ·å§‹æ—¥ä¸æœƒå°æ–¼ 1
        const currentDay = Math.max(1, challengeDayNum);
        
        const remainingDays = CHALLENGE_TOTAL_DAYS - currentDay;
        const progressPercent = Math.min(100, (currentDay / CHALLENGE_TOTAL_DAYS) * 100);

        let statusText = `ç›®æ¨™æ—¥æœŸï¼š${CHALLENGE_TOTAL_DAYS} å¤©æ¸›è„‚æŒ‘æˆ°`;
        let daysText = `ç¬¬ ${currentDay} å¤© / å…± ${CHALLENGE_TOTAL_DAYS} å¤©`;
        if (remainingDays < 0) {
            statusText = `æŒ‘æˆ°å·²æ–¼ ${Math.abs(remainingDays)} å¤©å‰çµæŸï¼æ­å–œå®Œæˆï¼`;
            daysText = `å…± ${CHALLENGE_TOTAL_DAYS} å¤© (å·²è¶…é¡ ${Math.abs(remainingDays)} å¤©)`;
        } else if (remainingDays === 0) {
            statusText = `ä»Šå¤©æ˜¯æœ€å¾Œä¸€å¤©ï¼è¡åˆºï¼`;
        }

        document.getElementById('countdown-container').innerHTML = `
            <h2>${statusText}</h2>
            <div class="progress-track">
                <div class="time-bar" style="width: ${progressPercent}%;"></div>
                <div class="weight-icon" style="left: ${progressPercent}%;">ğŸ‹ï¸</div>
            </div>
            <div class="progress-details">
                <span>èµ·å§‹: ${getFormattedDate(CHALLENGE_START_DATE)}</span>
                <span>${daysText}</span>
                <span>å‰©é¤˜: ${Math.max(0, remainingDays)} å¤©</span>
            </div>
        `;
    }

    // ---------------------- åŸå§‹æ•¸æ“šè¡¨æ ¼ ----------------------

    function renderRawDataTable() {
        const data = getData();
        const tbody = document.querySelector('#raw-data-table tbody');
        tbody.innerHTML = ''; // æ¸…ç©ºç¾æœ‰å…§å®¹

        // å€’åºé¡¯ç¤ºï¼Œæœ€æ–°ç´€éŒ„åœ¨å‰
        [...data].reverse().forEach(item => {
            const row = tbody.insertRow();
            
            // æ ¼å¼åŒ–æ™‚é–“ (æ—©ä¸Š/æ™šä¸Š)
            const timeDisplay = item.time === 'morning' ? 'æ—©ä¸Š' : 'æ™šä¸Š';

            row.insertCell().textContent = item.date;
            row.insertCell().textContent = timeDisplay;
            row.insertCell().textContent = item.weight !== null ? item.weight.toFixed(1) : '-';
            row.insertCell().textContent = item.bodyfat !== null ? item.bodyfat.toFixed(1) : '-';
            row.insertCell().textContent = item.muscleMass !== null ? item.muscleMass.toFixed(1) : '-';
            
            const actionCell = row.insertCell();
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.textContent = 'åˆªé™¤';
            deleteBtn.onclick = () => deleteData(item.timestamp);
            actionCell.appendChild(deleteBtn);
        });
    }

    // ---------------------- åˆå§‹åŒ– ----------------------

    function init() {
        updateCountdown();
        renderRawDataTable();
        // é è¨­æ¸²æŸ“ã€Œæ¯æ—¥æ•¸æ“šã€æ¨¡å¼
        renderAllCharts('daily'); 
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
