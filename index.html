<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å€‹äººå¥èº«æ•¸æ“šè¿½è¹¤</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/dist/date-fns.min.js"></script>
<style>
body {
  font-family: "Microsoft JhengHei", sans-serif;
  background: #f5f8fa;
  margin: 0;
  padding: 20px;
}
.container {
  max-width: 900px;
  margin: auto;
  background: #fff;
  padding: 25px;
  border-radius: 12px;
  box-shadow: 0 0 10px rgba(0,0,0,0.1);
}
h1 {
  text-align: center;
  color: #2c3e50;
}
#countdown-container {
  background: #f8f9fa;
  border: 1px solid #ddd;
  padding: 15px;
  border-radius: 10px;
  margin-bottom: 25px;
}
form {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-bottom: 20px;
}
form input, form select {
  padding: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
}
button {
  padding: 8px 12px;
  background: #3498db;
  color: white;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}
button:hover { background: #2e86de; }
canvas { background: #f9fcf9; border-radius: 8px; padding: 10px; }
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}
th, td {
  padding: 8px;
  border: 1px solid #ddd;
  text-align: center;
}
th { background: #f4f6f7; }
</style>
</head>
<body>
<div class="container">
  <h1>å€‹äººå¥èº«æ•¸æ“šè¿½è¹¤</h1>

  <div id="countdown-container"></div>

  <form id="data-entry-form">
    <input type="date" id="entry-date">
    <select id="entry-time">
      <option value="morning">æ—©ä¸Š</option>
      <option value="evening">æ™šä¸Š</option>
    </select>
    <input type="number" step="0.1" id="entry-weight" placeholder="é«”é‡ (kg)">
    <input type="number" step="0.1" id="entry-bodyfat" placeholder="é«”è„‚ (%)">
    <input type="number" step="0.1" id="entry-muscle" placeholder="éª¨éª¼è‚Œ (kg)">
    <button type="button" onclick="addData()">æ–°å¢ç´€éŒ„</button>
  </form>

  <div>
    <canvas id="weightChart" height="120"></canvas>
    <canvas id="bodyfatChart" height="120"></canvas>
    <canvas id="muscleChart" height="120"></canvas>
  </div>

  <table id="data-table">
    <thead>
      <tr>
        <th>æ—¥æœŸ</th>
        <th>æ™‚æ®µ</th>
        <th>é«”é‡</th>
        <th>é«”è„‚</th>
        <th>éª¨éª¼è‚Œ</th>
        <th>æ“ä½œ</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<script>
const CHALLENGE_START_DATE = '2025-10-20';
const CHALLENGE_TOTAL_DAYS = 100;
const START_WEIGHT = 83.1;
const GOAL_WEIGHT = 75;
let fitnessData = [];
let myCharts = {};

function getTodayKey() {
  const now = new Date();
  const local = new Date(now.getTime() + 8 * 60 * 60 * 1000);
  return local.toISOString().slice(0, 10);
}

async function init() {
  document.getElementById('entry-date').value = getTodayKey();
  await loadData();
  renderTable();
  renderCharts();
  updateCountdown();
}

// ç›´æ¥è®€å–é›²ç«¯ï¼ˆä¸ä½¿ç”¨ localStorageï¼‰
async function loadData() {
  try {
    const res = await fetch('/api/getData?key=fitnessData');
    if (!res.ok) throw new Error('fetch failed');
    fitnessData = await res.json();
  } catch (err) {
    alert('âš ï¸ ç„¡æ³•è®€å–é›²ç«¯è³‡æ–™ï¼Œè«‹ç¢ºèªä¼ºæœå™¨æ˜¯å¦é€£ç·šæ­£å¸¸');
    fitnessData = [];
  }
}

async function saveDataToCloud() {
  await fetch('/api/setData', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ key: 'fitnessData', data: fitnessData }),
  });
}

async function addData() {
  const date = document.getElementById('entry-date').value || getTodayKey();
  const timeOfDay = document.getElementById('entry-time').value;
  const weight = parseFloat(document.getElementById('entry-weight').value);
  const bodyFat = parseFloat(document.getElementById('entry-bodyfat').value);
  const muscleMass = parseFloat(document.getElementById('entry-muscle').value);

  if (!date || isNaN(weight) || isNaN(bodyFat) || isNaN(muscleMass)) {
    alert('è«‹å¡«å¯«å®Œæ•´è³‡æ–™');
    return;
  }

  const exist = fitnessData.find(d => d.date === date && d.timeOfDay === timeOfDay);
  if (exist) Object.assign(exist, { weight, bodyFat, muscleMass, timestamp: Date.now() });
  else fitnessData.push({ date, timeOfDay, weight, bodyFat, muscleMass, timestamp: Date.now() });

  await saveDataToCloud();
  renderTable();
  renderCharts();
  updateCountdown();
}

async function deleteData(timestamp) {
  if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™ç­†è³‡æ–™å—ï¼Ÿ')) return;
  fitnessData = fitnessData.filter(d => d.timestamp !== timestamp);
  await saveDataToCloud();
  renderTable();
  renderCharts();
  updateCountdown();
}

async function editData(timestamp) {
  const d = fitnessData.find(x => x.timestamp === timestamp);
  if (!d) return;
  const w = prompt('é«”é‡', d.weight);
  const f = prompt('é«”è„‚', d.bodyFat);
  const m = prompt('éª¨éª¼è‚Œ', d.muscleMass);
  if (!w || !f || !m) return;
  Object.assign(d, { weight: parseFloat(w), bodyFat: parseFloat(f), muscleMass: parseFloat(m), timestamp: Date.now() });
  await saveDataToCloud();
  renderTable();
  renderCharts();
  updateCountdown();
}

function renderTable() {
  const tbody = document.querySelector('#data-table tbody');
  tbody.innerHTML = '';
  const sorted = [...fitnessData].sort((a, b) => b.timestamp - a.timestamp);
  for (const d of sorted) {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${d.date}</td>
      <td>${d.timeOfDay === 'morning' ? 'æ—©ä¸Š' : 'æ™šä¸Š'}</td>
      <td>${d.weight.toFixed(1)}</td>
      <td>${d.bodyFat.toFixed(1)}</td>
      <td>${d.muscleMass.toFixed(1)}</td>
      <td>
        <button onclick="editData(${d.timestamp})">âœï¸</button>
        <button onclick="deleteData(${d.timestamp})">ğŸ—‘ï¸</button>
      </td>
    `;
    tbody.appendChild(tr);
  }
}

function avg(arr) { return arr.length ? arr.reduce((a,b)=>a+b)/arr.length : null; }

function aggregateData(data) {
  const map = new Map();
  data.forEach(d => {
    const key = d.date;
    const g = map.get(key) || { morning: [], evening: [] };
    g[d.timeOfDay].push(d);
    map.set(key, g);
  });
  const labels = [], morning = { weight: [], bodyFat: [], muscleMass: [] }, evening = { weight: [], bodyFat: [], muscleMass: [] };
  for (const [k,g] of map.entries()) {
    labels.push(k);
    ['weight','bodyFat','muscleMass'].forEach(metric=>{
      morning[metric].push(avg(g.morning.map(x=>x[metric])));
      evening[metric].push(avg(g.evening.map(x=>x[metric])));
    });
  }
  return { labels, morning, evening };
}

function createChart(canvasId, data, label, unit) {
  const ctx = document.getElementById(canvasId);
  if (myCharts[canvasId]) myCharts[canvasId].destroy();
  myCharts[canvasId] = new Chart(ctx, {
    type: 'line',
    data: {
      labels: data.labels,
      datasets: [
        { label:`æ—©ä¸Š${label}`, data:data.morning[unit], borderColor:'#777', fill:false, tension:0.3 },
        { label:`æ™šä¸Š${label}`, data:data.evening[unit], borderColor:'#000', fill:false, tension:0.3 }
      ]
    },
    options: { scales:{ x:{ ticks:{ autoSkip:true }, grid:{ color:'#eee' } } } }
  });
}

function renderCharts() {
  const agg = aggregateData(fitnessData);
  createChart('weightChart', agg, 'é«”é‡', 'weight');
  createChart('bodyfatChart', agg, 'é«”è„‚', 'bodyFat');
  createChart('muscleChart', agg, 'éª¨éª¼è‚Œ', 'muscleMass');
}

// â±ï¸ å€’æ•¸æŒ‘æˆ° + é«”é‡é€²åº¦æ¢
function updateCountdown() {
  const start = new Date(CHALLENGE_START_DATE);
  const today = new Date();
  const diffDays = Math.floor((today - start) / (1000 * 60 * 60 * 24));
  const dayCount = Math.max(0, Math.min(CHALLENGE_TOTAL_DAYS, diffDays));
  const remain = CHALLENGE_TOTAL_DAYS - dayCount;
  const percent = Math.min(100, (dayCount / CHALLENGE_TOTAL_DAYS) * 100);

  const sorted = [...fitnessData].sort((a,b)=>b.timestamp - a.timestamp);
  const currentWeight = sorted.length ? sorted[0].weight : START_WEIGHT;
  const totalDiff = START_WEIGHT - GOAL_WEIGHT;
  const currentDiff = START_WEIGHT - currentWeight;
  const weightPercent = Math.min(100, Math.max(0, (currentDiff / totalDiff) * 100));

  const c = document.getElementById('countdown-container');
  c.innerHTML = `
    <div style="font-weight:bold;margin-bottom:8px;">ğŸ”¥ ç¬¬ ${dayCount} å¤©ã€€å‰©é¤˜ ${remain} å¤©</div>
    <div style="background:#ddd;border-radius:8px;height:20px;width:100%;">
      <div style="background:#2e86de;width:${percent}%;height:100%;border-radius:8px;"></div>
    </div>
    <div style="margin-top:5px;font-size:14px;">æŒ‘æˆ°é€²åº¦ ${percent.toFixed(1)}%</div>

    <div style="margin-top:16px;font-weight:bold;">âš–ï¸ é«”é‡é€²åº¦</div>
    <div style="font-size:14px;margin-bottom:4px;">
      èµ·å§‹ ${START_WEIGHT} kg â†’ ç›®æ¨™ ${GOAL_WEIGHT} kgã€€ç›®å‰ <b>${currentWeight.toFixed(1)} kg</b>
    </div>
    <div style="background:#ddd;border-radius:8px;height:20px;width:100%;">
      <div style="background:#27ae60;width:${weightPercent}%;height:100%;border-radius:8px;"></div>
    </div>
    <div style="margin-top:5px;font-size:14px;">
      é«”é‡å·²æ¸› ${currentDiff.toFixed(1)} kgï¼ˆé”æˆç‡ ${weightPercent.toFixed(1)}%ï¼‰
    </div>
  `;
}

init();
</script>
</body>
</html>
