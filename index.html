<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>數據追蹤 - 個人健身追蹤器</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 900px; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #1a237e; }
        h1, h2 { border-bottom: 2px solid #3f51b5; padding-bottom: 10px; margin-top: 20px; }
        h1 { margin-top: 0; }
        nav { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 5px; }
        nav a { text-decoration: none; flex-grow: 1; padding: 10px 15px; border: none; background-color: #e8eaf6; color: #3f51b5; cursor: pointer; border-radius: 5px; font-size: 16px; transition: background-color 0.3s; text-align: center; }
        nav a.active { background-color: #3f51b5; color: white; font-weight: bold; }
        #data-entry-form { background-color: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        .form-row { display: flex; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .form-row:last-child { margin-bottom: 0; }
        .form-row label { font-weight: bold; margin-right: -5px; }
        .form-row input[type="date"], .form-row input[type="number"], .form-row input[type="text"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .form-row input[type="number"] { flex: 1; min-width: 100px; }
        .radio-group { display: flex; align-items: center; gap: 15px; margin-left: 10px; }
        .button-row { justify-content: flex-end; }
        button { padding: 10px 20px; border: none; background-color: #4caf50; color: white; border-radius: 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button:hover { background-color: #45a049; }
        #chart-controls { margin: 20px 0; display: flex; align-items: center; flex-wrap: wrap; }
        #chart-controls button { background-color: #9fa8da; margin-right: 5px; margin-bottom: 5px; }
        #chart-controls button.active { background-color: #5c6bc0; }
        canvas { margin-top: 20px; border-radius: 8px; }
        #raw-data-table-container { margin-top: 30px; max-height: 400px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; }
        #raw-data-table { width: 100%; border-collapse: collapse; }
        #raw-data-table th, #raw-data-table td { padding: 10px 15px; text-align: left; border-bottom: 1px solid #eee; }
        #raw-data-table th { background-color: #e8eaf6; color: #3f51b5; font-weight: bold; position: sticky; top: 0; z-index: 1; }
        #raw-data-table td button { background-color: #2196f3; margin-right: 5px; padding: 6px 10px; font-size: 12px; }
        #raw-data-table td button.delete-btn { background-color: #f44336; }
    </style>
</head>
<body>
    <div class="container">
        <h1>個人健身追蹤器</h1>
        <nav>
            <a href="index.html" class="active">數據追蹤</a>
            <a href="workout.html">今日課表</a>
            <a href="diet.html">飲食紀錄</a>
        </nav>

        <div id="page-tracker">
            <h2>數據輸入</h2>
            <div id="data-entry-form">
                <div class="form-row">
                    <label for="entry-date">日期:</label>
                    <input type="date" id="entry-date">
                    <div class="radio-group">
                        <input type="radio" id="time-morning" name="time-of-day" value="morning" checked>
                        <label for="time-morning">早上</label>
                        <input type="radio" id="time-evening" name="time-of-day" value="evening">
                        <label for="time-evening">晚上</label>
                    </div>
                </div>
                <div class="form-row">
                    <label for="weight">體重(kg):</label>
                    <input type="number" id="weight" step="0.1" placeholder="75.5">
                    <label for="bodyfat">體脂(%):</label>
                    <input type="number" id="bodyfat" step="0.1" placeholder="18.5">
                    <label for="muscle-mass">骨骼肌(kg):</label>
                    <input type="number" id="muscle-mass" step="0.1" placeholder="35.0">
                </div>
                <div class="form-row button-row">
                    <button onclick="addData()">新增紀錄</button>
                </div>
            </div>
            <div id="chart-controls">
                <span>檢視模式:</span>
                <button id="btn-daily" class="active" onclick="renderAllCharts('daily')">每日數據</button>
                <button id="btn-weekly" onclick="renderAllCharts('weekly')">每週平均</button>
                <button id="btn-monthly" onclick="renderAllCharts('monthly')">每月平均</button>
            </div>
            <h2>體重趨勢</h2>
            <canvas id="weightChart"></canvas>
            <h2>體脂趨勢</h2>
            <canvas id="bodyfatChart"></canvas>
            <h2>骨骼肌趨勢</h2>
            <canvas id="muscleMassChart"></canvas>
            <h2>原始數據 (RAW Data)</h2>
            <div id="raw-data-table-container">
                <table id="raw-data-table">
                    <thead>
                        <tr>
                            <th>日期</th><th>時間</th><th>體重(kg)</th><th>體脂(%)</th><th>骨骼肌(kg)</th><th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

<script>
    let weightChart, bodyfatChart, muscleMassChart;
    let fitnessData = JSON.parse(localStorage.getItem('fitnessData')) || [];

    function addData() {
        const date = document.getElementById('entry-date').value;
        const timeOfDay = document.querySelector('input[name="time-of-day"]:checked').value;
        const weight = parseFloat(document.getElementById('weight').value);
        const bodyfat = parseFloat(document.getElementById('bodyfat').value);
        const muscleMass = parseFloat(document.getElementById('muscle-mass').value);

        if (!date || isNaN(weight) || isNaN(bodyfat) || isNaN(muscleMass)) {
            alert('請輸入有效的日期、體重、體脂和骨骼肌重量！');
            return;
        }

        const lastInputs = { weight, bodyfat, muscleMass };
        localStorage.setItem('lastFitnessInputs', JSON.stringify(lastInputs));

        const newEntry = { date, time: timeOfDay, weight, bodyfat, muscleMass };
        const existingIndex = fitnessData.findIndex(d => d.date === date && d.time === timeOfDay);
        if (existingIndex > -1) {
            fitnessData[existingIndex] = newEntry;
        } else {
            fitnessData.push(newEntry);
        }
        
        fitnessData.sort((a, b) => new Date(`${a.date} ${a.time === 'morning' ? '08:00' : '20:00'}`) - new Date(`${b.date} ${b.time === 'morning' ? '08:00' : '20:00'}`));

        saveFitnessData();
        renderAllCharts();
        renderRawDataTable();
    }
    
    function saveFitnessData() {
        localStorage.setItem('fitnessData', JSON.stringify(fitnessData));
    }

    function getAggregatedData(period) {
        if (fitnessData.length === 0) return { labels: [], morning: {}, evening: {} };
        const groups = {};
        fitnessData.forEach(d => {
            const date = new Date(d.date);
            let key;
            if (period === 'weekly') {
                const day = date.getDay();
                const diff = date.getDate() - day + (day === 0 ? -6 : 1);
                key = new Date(date.setDate(diff)).toISOString().split('T')[0];
            } else {
                key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            }

            if (!groups[key]) {
                groups[key] = {
                    weightsM: [], bodyfatsM: [], musclesM: [],
                    weightsE: [], bodyfatsE: [], musclesE: [],
                };
            }
            if (d.time === 'morning') {
                groups[key].weightsM.push(d.weight);
                groups[key].bodyfatsM.push(d.bodyfat);
                groups[key].musclesM.push(d.muscleMass);
            } else {
                groups[key].weightsE.push(d.weight);
                groups[key].bodyfatsE.push(d.bodyfat);
                groups[key].musclesE.push(d.muscleMass);
            }
        });
        
        const labels = Object.keys(groups).sort();
        const getAverage = arr => arr.length > 0 ? (arr.reduce((a, b) => a + b, 0) / arr.length).toFixed(2) : NaN;
        
        return {
            labels,
            morning: {
                weight: labels.map(key => getAverage(groups[key].weightsM)),
                bodyfat: labels.map(key => getAverage(groups[key].bodyfatsM)),
                muscleMass: labels.map(key => getAverage(groups[key].musclesM)),
            },
            evening: {
                weight: labels.map(key => getAverage(groups[key].weightsE)),
                bodyfat: labels.map(key => getAverage(groups[key].bodyfatsE)),
                muscleMass: labels.map(key => getAverage(groups[key].musclesE)),
            }
        };
    }

    function createChart(canvasId, yAxisLabel, morningData, eveningData, labels, timeUnit) {
        const ctx = document.getElementById(canvasId).getContext('2d');
        ctx.canvas.style.backgroundColor = '#E6F5E6';

        return new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: `早上 (${yAxisLabel.split(' ')[0]})`,
                    data: morningData,
                    pointBackgroundColor: 'rgba(255, 255, 255, 1)',
                    pointBorderColor: 'rgba(0, 0, 0, 1)',
                    pointBorderWidth: 1.5,
                    borderColor: 'rgba(0, 0, 0, 0.6)',
                    tension: 0.1,
                    segment: { borderColor: ctx => ctx.p0.parsed.y === null || ctx.p1.parsed.y === null ? 'transparent' : 'rgba(0, 0, 0, 0.6)' }
                }, {
                    label: `晚上 (${yAxisLabel.split(' ')[0]})`,
                    data: eveningData,
                    borderColor: 'rgba(0, 0, 0, 1)',
                    backgroundColor: 'rgba(0, 0, 0, 0.1)',
                    pointBackgroundColor: 'rgba(0, 0, 0, 1)',
                    tension: 0.1,
                    segment: { borderColor: ctx => ctx.p0.parsed.y === null || ctx.p1.parsed.y === null ? 'transparent' : 'rgba(0, 0, 0, 1)' }
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: timeUnit, tooltipFormat: 'yyyy-MM-dd' },
                        title: { display: true, text: '日期' }
                    },
                    y: {
                        position: 'left',
                        title: { display: true, text: yAxisLabel }
                    }
                }
            }
        });
    }

    function renderAllCharts(mode = 'daily') {
        document.querySelectorAll('#chart-controls button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${mode}`).classList.add('active');

        if (weightChart) weightChart.destroy();
        if (bodyfatChart) bodyfatChart.destroy();
        if (muscleMassChart) muscleMassChart.destroy();

        let labels, morningData, eveningData;
        let timeUnit = 'day';

        if (mode === 'daily') {
            labels = fitnessData.map(d => d.date);
            morningData = {
                weight: fitnessData.map(d => d.time === 'morning' ? d.weight : NaN),
                bodyfat: fitnessData.map(d => d.time === 'morning' ? d.bodyfat : NaN),
                muscleMass: fitnessData.map(d => d.time === 'morning' ? d.muscleMass : NaN),
            };
            eveningData = {
                weight: fitnessData.map(d => d.time === 'evening' ? d.weight : NaN),
                bodyfat: fitnessData.map(d => d.time === 'evening' ? d.bodyfat : NaN),
                muscleMass: fitnessData.map(d => d.time === 'evening' ? d.muscleMass : NaN),
            };
        } else {
            const aggregated = getAggregatedData(mode);
            labels = aggregated.labels;
            morningData = aggregated.morning;
            eveningData = aggregated.evening;
            timeUnit = mode === 'weekly' ? 'week' : 'month';
        }

        weightChart = createChart('weightChart', '體重 (kg)', morningData.weight, eveningData.weight, labels, timeUnit);
        bodyfatChart = createChart('bodyfatChart', '體脂 (%)', morningData.bodyfat, eveningData.bodyfat, labels, timeUnit);
        muscleMassChart = createChart('muscleMassChart', '骨骼肌 (kg)', morningData.muscleMass, eveningData.muscleMass, labels, timeUnit);
    }

    function renderRawDataTable() {
        const tableBody = document.getElementById('raw-data-table').querySelector('tbody');
        tableBody.innerHTML = '';
        [...fitnessData].reverse().forEach((entry, reverseIndex) => {
            const actualIndex = fitnessData.length - 1 - reverseIndex;
            const row = tableBody.insertRow();
            row.setAttribute('data-index', actualIndex);
            row.innerHTML = `<td>${entry.date}</td><td>${entry.time === 'morning' ? '早上' : '晚上'}</td><td>${entry.weight}</td><td>${entry.bodyfat}</td><td>${entry.muscleMass}</td><td><button onclick="editRawData(${actualIndex})">編輯</button><button class="delete-btn" onclick="deleteRawData(${actualIndex})">刪除</button></td>`;
        });
    }

    function deleteRawData(index) {
        if (confirm('確定要刪除這筆數據嗎？')) {
            fitnessData.splice(index, 1);
            saveFitnessData();
            renderAllCharts();
            renderRawDataTable();
        }
    }

    function editRawData(index) {
        const entry = fitnessData[index];
        const newWeight = prompt("請輸入新的體重 (kg):", entry.weight);
        const newBodyfat = prompt("請輸入新的體脂 (%):", entry.bodyfat);
        const newMuscleMass = prompt("請輸入新的骨骼肌 (kg):", entry.muscleMass);
        
        const weight = parseFloat(newWeight);
        const bodyfat = parseFloat(newBodyfat);
        const muscleMass = parseFloat(newMuscleMass);

        if (isNaN(weight) || isNaN(bodyfat) || isNaN(muscleMass)) {
            alert("輸入無效，操作已取消。");
            return;
        }

        fitnessData[index].weight = weight;
        fitnessData[index].bodyfat = bodyfat;
        fitnessData[index].muscleMass = muscleMass;
        
        saveFitnessData();
        renderAllCharts();
        renderRawDataTable();
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('entry-date').value = new Date().toISOString().split('T')[0];
        const lastInputs = JSON.parse(localStorage.getItem('lastFitnessInputs'));
        if (lastInputs) {
            document.getElementById('weight').value = lastInputs.weight;
            document.getElementById('bodyfat').value = lastInputs.bodyfat;
            document.getElementById('muscle-mass').value = lastInputs.muscleMass;
        }
        renderAllCharts();
        renderRawDataTable();
    });
</script>
</body>
</html>