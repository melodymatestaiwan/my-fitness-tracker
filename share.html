<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分享與成果 - 個人健身追蹤器</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 900px; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2 { color: #1a237e; border-bottom: 2px solid #3f51b5; padding-bottom: 10px; margin-top: 20px; }
        h1 { margin-top: 0; }
        nav { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 5px; }
        nav a { text-decoration: none; flex-grow: 1; padding: 10px 15px; border: none; background-color: #e8eaf6; color: #3f51b5; cursor: pointer; border-radius: 5px; font-size: 16px; transition: background-color 0.3s; text-align: center; }
        nav a.active { background-color: #3f51b5; color: white; font-weight: bold; }

        .image-section { text-align: center; margin-top: 25px; }
        #generate-share-btn {
            background-color: #ff9800;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 30px; /* 增加按鈕與圖片之間的間距 */
        }
        #generate-share-btn:hover { background-color: #fb8c00; }
        #generate-share-btn:disabled { background-color: #cccccc; cursor: not-allowed; }

        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3f51b5;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none; /* 預設隱藏 */
            margin-left: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #share-images-container {
            display: flex;
            flex-direction: column; /* 確保圖片垂直排列 */
            align-items: center;
            gap: 20px; /* 圖片之間的間距 */
            margin-top: 20px; /* 圖片區塊與按鈕的間距 */
        }
        #share-images-container img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .download-btn {
            background-color: #4caf50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 20px; /* 下載按鈕與圖片的間距 */
        }
        .download-btn:hover { background-color: #43a047; }
        .error-message { color: red; margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>個人健身追蹤器</h1>
        <nav>
            <a href="index.html">數據追蹤</a>
            <a href="workout.html">今日課表</a>
            <a href="diet.html">飲食紀錄</a>
            <a href="share.html" class="active">分享與成果</a>
        </nav>

        <h2>生成每日分享圖</h2>
        <div class="image-section">
            <button id="generate-share-btn">
                <span>產生每日分享圖 (三張)</span>
                <div class="loading-spinner" id="spinner"></div>
            </button>
            <div id="error-message" class="error-message"></div>
            <div id="share-images-container">
                </div>
            <button id="download-all-btn" class="download-btn" style="display: none;">下載所有圖片</button>
        </div>
    </div>

    <script>
        const generateBtn = document.getElementById('generate-share-btn');
        const spinner = document.getElementById('spinner');
        const imagesContainer = document.getElementById('share-images-container');
        const downloadAllBtn = document.getElementById('download-all-btn');
        const errorMessageDiv = document.getElementById('error-message');

        generateBtn.addEventListener('click', async () => {
            generateBtn.disabled = true;
            spinner.style.display = 'block';
            imagesContainer.innerHTML = '';
            downloadAllBtn.style.display = 'none';
            errorMessageDiv.textContent = '';

            try {
                const response = await fetch('/api/generateShareImages', { method: 'POST' });
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`伺服器錯誤: ${response.status} - ${errorText}`);
                }
                const data = await response.json();

                if (data.images && data.images.length > 0) {
                    data.images.forEach((base64Image, index) => {
                        const img = document.createElement('img');
                        img.src = `data:image/png;base64,${base64Image}`;
                        img.alt = `分享圖 ${index + 1}`;
                        imagesContainer.appendChild(img);
                    });
                    downloadAllBtn.style.display = 'block';
                } else {
                    errorMessageDiv.textContent = '未收到任何圖片，請稍後再試。';
                }
            } catch (error) {
                console.error('生成圖片失敗:', error);
                errorMessageDiv.textContent = `生成圖片失敗: ${error.message || '未知錯誤'}`;
            } finally {
                generateBtn.disabled = false;
                spinner.style.display = 'none';
            }
        });

        downloadAllBtn.addEventListener('click', () => {
            const images = imagesContainer.querySelectorAll('img');
            images.forEach((img, index) => {
                const link = document.createElement('a');
                link.href = img.src;
                link.download = `健身分享圖_${index + 1}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        });
    </script>
</body>
</html>
