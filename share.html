<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分享與成果 - 個人健身追蹤器</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 900px; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #1a237e; border-bottom: 2px solid #3f51b5; padding-bottom: 10px; margin-top: 20px; }
        h1 { margin-top: 0; }
        nav { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 5px; }
        nav a { text-decoration: none; flex-grow: 1; padding: 10px 15px; border: none; background-color: #e8eaf6; color: #3f51b5; cursor: pointer; border-radius: 5px; font-size: 16px; transition: background-color 0.3s; text-align: center; }
        nav a.active { background-color: #3f51b5; color: white; font-weight: bold; }
        .loading-box { padding: 30px; text-align: center; border: 1px dashed #ccc; margin-top: 20px; color: #f44336; }

        /* --- 分享圖樣式 (Share Card Styles) --- */
        #share-card-wrapper { display: flex; justify-content: center; margin-top: 30px; }
        #share-card {
            width: 375px; /* 模擬手機寬度 */
            height: 667px; /* 模擬手機高度 */
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border-radius: 15px;
            color: #1a237e;
            position: relative;
        }
        .card-header { text-align: center; margin-bottom: 20px; }
        .card-header h2 { margin: 0; font-size: 24px; border-bottom: none; color: #3f51b5; }
        .card-header p { margin: 5px 0 0; font-size: 14px; color: #5c6bc0; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center; margin-bottom: 20px; }
        .stat-item { background-color: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-label { font-size: 12px; color: #3f51b5; font-weight: bold; }
        .stat-value { font-size: 20px; font-weight: bold; color: #1a237e; }
        .daily-log-item { background-color: rgba(255, 255, 255, 0.9); padding: 8px 15px; border-radius: 8px; margin-bottom: 8px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .log-macro { font-weight: bold; color: #4caf50; }
        .log-time { font-size: 10px; color: #999; }
        .btn-action { text-align: center; margin-top: 20px; }
        .btn-action button { background-color: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        .btn-action button:hover { background-color: #45a049; }
        #image-preview { margin-top: 20px; text-align: center; }
        #image-preview img { max-width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class="container">
        <h1>個人健身追蹤器</h1>
        <nav>
            <a href="index.html">數據追蹤</a>
            <a href="workout.html">今日課表</a>
            <a href="diet.html">飲食紀錄</a>
            <a href="share.html" class="active">分享與成果</a>
        </nav>

        <h2>生成每日分享圖</h2>
        <div class="loading-box" id="loading-box">
            讀取雲端資料中...
        </div>

        <div id="share-content" style="display:none;">
            <p>點擊下方按鈕，將今天的成果轉換為圖片：</p>
            <div class="btn-action">
                <button onclick="generateImage()">生成分享圖片</button>
            </div>

            <div id="share-card-wrapper">
                <div id="share-card">
                    <div class="card-header">
                        <h2>我的今日成果</h2>
                        <p id="share-date"></p>
                    </div>

                    <h3>身體數據</h3>
                    <div class="stat-grid" id="stat-grid-data">
                        <div class="stat-item"><div class="stat-label">體重</div><div class="stat-value" id="stat-weight">--</div></div>
                        <div class="stat-item"><div class="stat-label">體脂</div><div class="stat-value" id="stat-bodyfat">--</div></div>
                        <div class="stat-item"><div class="stat-label">骨骼肌</div><div class="stat-value" id="stat-muscle">--</div></div>
                    </div>

                    <h3>今日飲食總計</h3>
                    <div class="stat-grid" id="macro-grid-data">
                        <div class="stat-item" style="background-color: #fce4ec;"><div class="stat-label">熱量</div><div class="stat-value" id="stat-cal">--</div></div>
                        <div class="stat-item" style="background-color: #e3f2fd;"><div class="stat-label">蛋白質</div><div class="stat-value" id="stat-protein">--</div></div>
                        <div class="stat-item" style="background-color: #fffde7;"><div class="stat-label">碳水</div><div class="stat-value" id="stat-carbs">--</div></div>
                    </div>
                    
                    <h3>完成訓練</h3>
                    <div id="workout-log-list">
                        <div class="daily-log-item"><span>💪 訓練紀錄載入中...</span></div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px; font-size: 14px; color: #5c6bc0;">#健身追蹤器 #ProgressTracker</div>
                    <div style="text-align: center; font-size: 10px; color: #9fa8da;">Generated by Personal Fitness Tracker</div>
                </div>
            </div>
            
            <div id="image-preview">
                </div>
        </div>

    </div>

<script>
    // --- 通用日期函數 ---
    function getTodayKey() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // --- 雲端讀取 ---
    async function loadData(key) { 
        try { 
            const response = await fetch(`/api/getData?key=${key}`); 
            const data = await response.json(); 
            return data || (key === 'workoutLog' || key === 'dietLog' ? {} : []); 
        } catch (error) { 
            console.error(`Failed to load ${key}:`, error); 
            // 如果讀取失敗，拋出錯誤，讓主程序知道
            throw new Error(`讀取雲端 ${key} 失敗！`);
        } 
    }

    // --- 數據處理 ---
    function processFitnessData(fitnessData) {
        const todayKey = getTodayKey();
        // 嘗試獲取最新的早上和晚上數據
        const morningEntry = fitnessData.filter(d => d.date === todayKey && d.time === 'morning').pop();
        const eveningEntry = fitnessData.filter(d => d.date === todayKey && d.time === 'evening').pop();
        
        // 優先顯示早上數據，如果沒有，則使用晚上數據作為最新數據
        const latestEntry = morningEntry || eveningEntry; 
        
        if (latestEntry) {
            return {
                weight: latestEntry.weight ? `${latestEntry.weight.toFixed(1)} kg` : '--',
                bodyfat: latestEntry.bodyfat ? `${latestEntry.bodyfat.toFixed(1)} %` : '--',
                muscleMass: latestEntry.muscleMass ? `${latestEntry.muscleMass.toFixed(1)} kg` : '--'
            };
        }
        return { weight: '--', bodyfat: '--', muscleMass: '--' };
    }

    function processDietData(dietLog) {
        const todayKey = getTodayKey();
        const logsForDay = dietLog[todayKey] || [];
        
        const totals = logsForDay.reduce((acc, item) => {
            acc.protein += item.protein;
            acc.carbs += item.carbs;
            acc.fat += item.fat;
            return acc;
        }, { protein: 0, carbs: 0, fat: 0 });

        const totalCalories = (totals.protein * 4) + (totals.carbs * 4) + (totals.fat * 9);
        
        return {
            cal: Math.round(totalCalories),
            protein: totals.protein.toFixed(1),
            carbs: totals.carbs.toFixed(1),
            fat: totals.fat.toFixed(1)
        };
    }

    function processWorkoutData(workoutLog) {
        const todayKey = getTodayKey();
        const dayKeys = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
        const todayDate = new Date();
        const todayInTaiwan = new Date(todayDate.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
        const currentDayKey = dayKeys[todayInTaiwan.getDay()];
        
        const logsForDay = workoutLog[currentDayKey] || {};
        const workoutList = [];
        
        // 遍歷當天所有訓練項目 (包括預設和自訂)
        for (const exerciseName in logsForDay) {
            const sets = logsForDay[exerciseName][todayKey] || [];
            if (sets.length > 0) {
                 // 統計組數和代表數據
                const count = sets.length;
                const weightSets = sets.filter(s => s.type === 'weight');
                const timeSets = sets.filter(s => s.type === 'time');
                let summary = `共 ${count} 組`;

                if (weightSets.length > 0) {
                     // 找到最大重量
                    const maxWeight = Math.max(...weightSets.map(s => s.weight));
                    summary = `${maxWeight}kg / 共 ${weightSets.length} 組`;
                } else if (timeSets.length > 0) {
                     // 統計總時長
                    const totalDuration = timeSets.reduce((sum, s) => sum + s.duration, 0);
                    summary = `${totalDuration} 分鐘`;
                }

                workoutList.push({ name: exerciseName, summary });
            }
        }
        return workoutList;
    }

    // --- 渲染數據到卡片 ---
    function renderCardData(data) {
        document.getElementById('share-date').textContent = getTodayKey();
        
        // 身體數據
        document.getElementById('stat-weight').textContent = data.fitness.weight;
        document.getElementById('stat-bodyfat').textContent = data.fitness.bodyfat;
        document.getElementById('stat-muscle').textContent = data.fitness.muscleMass;

        // 飲食數據
        document.getElementById('stat-cal').textContent = `${data.diet.cal} 大卡`;
        document.getElementById('stat-protein').textContent = `${data.diet.protein} g`;
        document.getElementById('stat-carbs').textContent = `${data.diet.carbs} g`;
        
        // 訓練數據
        const workoutListEl = document.getElementById('workout-log-list');
        workoutListEl.innerHTML = '';

        if (data.workout.length === 0) {
            workoutListEl.innerHTML = `<div class="daily-log-item"><span>💪 今天還沒紀錄訓練哦！</span></div>`;
            return;
        }

        data.workout.forEach(item => {
            const div = document.createElement('div');
            div.className = 'daily-log-item';
            div.innerHTML = `
                <span>${item.name}</span>
                <span class="log-macro">${item.summary}</span>
            `;
            workoutListEl.appendChild(div);
        });
    }

    // --- 主初始化程序 ---
    async function initSharePage() {
        const loadingBox = document.getElementById('loading-box');
        const shareContent = document.getElementById('share-content');
        
        loadingBox.textContent = '讀取雲端資料中...';
        
        try {
            // 一次讀取所有必要的數據
            const fitnessData = await loadData('fitnessData');
            const dietLog = await loadData('dietLog');
            const workoutLog = await loadData('workoutLog');

            // 處理數據
            const fitnessResults = processFitnessData(fitnessData);
            const dietResults = processDietData(dietLog);
            const workoutResults = processWorkoutData(workoutLog);

            // 渲染卡片
            renderCardData({
                fitness: fitnessResults,
                diet: dietResults,
                workout: workoutResults
            });

            // 顯示內容並隱藏加載框
            shareContent.style.display = 'block';
            loadingBox.style.display = 'none';

        } catch (error) {
            console.error(error);
            loadingBox.textContent = `讀取雲端資料失敗！請檢查您的 Vercel API 或重新整理。錯誤: ${error.message}`;
            loadingBox.style.color = '#f44336';
            loadingBox.style.borderColor = '#f44336';
        }
    }

    // --- 圖片生成函數 ---
    function generateImage() {
        const card = document.getElementById('share-card');
        const preview = document.getElementById('image-preview');
        preview.innerHTML = '生成中...';

        html2canvas(card, {
            backgroundColor: null, // 保持透明背景
            useCORS: true // 允許跨域圖像（如果有）
        }).then(canvas => {
            preview.innerHTML = '';
            const img = document.createElement('img');
            img.src = canvas.toDataURL('image/png');
            img.alt = '每日分享圖片';
            preview.appendChild(img);
            
            // 提供下載連結
            const downloadLink = document.createElement('a');
            downloadLink.href = img.src;
            downloadLink.download = `Fitness_Daily_Share_${getTodayKey()}.png`;
            downloadLink.textContent = '點擊下載圖片';
            downloadLink.style.display = 'block';
            downloadLink.style.marginTop = '15px';
            preview.appendChild(downloadLink);
            
            alert('圖片已成功生成！');
        }).catch(err => {
            console.error('圖片生成失敗:', err);
            preview.innerHTML = `<p style="color:red;">圖片生成失敗。請嘗試重新整理頁面。</p>`;
        });
    }

    document.addEventListener('DOMContentLoaded', initSharePage);
</script>
</body>
</html>
