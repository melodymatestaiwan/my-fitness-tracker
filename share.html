<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ†äº«èˆ‡æˆæœ - å€‹äººå¥èº«è¿½è¹¤å™¨</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 900px; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #1a237e; border-bottom: 2px solid #3f51b5; padding-bottom: 10px; margin-top: 20px; }
        h1 { margin-top: 0; }
        nav { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 5px; }
        nav a { text-decoration: none; flex-grow: 1; padding: 10px 15px; border: none; background-color: #e8eaf6; color: #3f51b5; cursor: pointer; border-radius: 5px; font-size: 16px; transition: background-color 0.3s; text-align: center; }
        nav a.active { background-color: #3f51b5; color: white; font-weight: bold; }
        .loading-box { padding: 30px; text-align: center; border: 1px dashed #ccc; margin-top: 20px; color: #f44336; }

        /* --- åˆ†äº«åœ–æ¨£å¼ (Share Card Styles) --- */
        #share-card-wrapper { display: flex; justify-content: center; margin-top: 30px; }
        #share-card {
            width: 375px; /* æ¨¡æ“¬æ‰‹æ©Ÿå¯¬åº¦ */
            height: 667px; /* æ¨¡æ“¬æ‰‹æ©Ÿé«˜åº¦ */
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            padding: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            border-radius: 15px;
            color: #1a237e;
            position: relative;
        }
        .card-header { text-align: center; margin-bottom: 20px; }
        .card-header h2 { margin: 0; font-size: 24px; border-bottom: none; color: #3f51b5; }
        .card-header p { margin: 5px 0 0; font-size: 14px; color: #5c6bc0; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center; margin-bottom: 20px; }
        .stat-item { background-color: rgba(255, 255, 255, 0.8); padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .stat-label { font-size: 12px; color: #3f51b5; font-weight: bold; }
        .stat-value { font-size: 20px; font-weight: bold; color: #1a237e; }
        .daily-log-item { background-color: rgba(255, 255, 255, 0.9); padding: 8px 15px; border-radius: 8px; margin-bottom: 8px; font-size: 14px; display: flex; justify-content: space-between; align-items: center; }
        .log-macro { font-weight: bold; color: #4caf50; }
        .log-time { font-size: 10px; color: #999; }
        .btn-action { text-align: center; margin-top: 20px; }
        .btn-action button { background-color: #4caf50; color: white; padding: 10px 20px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; transition: background-color 0.3s; }
        .btn-action button:hover { background-color: #45a049; }
        #image-preview { margin-top: 20px; text-align: center; }
        #image-preview img { max-width: 100%; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>
    <div class="container">
        <h1>å€‹äººå¥èº«è¿½è¹¤å™¨</h1>
        <nav>
            <a href="index.html">æ•¸æ“šè¿½è¹¤</a>
            <a href="workout.html">ä»Šæ—¥èª²è¡¨</a>
            <a href="diet.html">é£²é£Ÿç´€éŒ„</a>
            <a href="share.html" class="active">åˆ†äº«èˆ‡æˆæœ</a>
        </nav>

        <h2>ç”Ÿæˆæ¯æ—¥åˆ†äº«åœ–</h2>
        <div class="loading-box" id="loading-box">
            è®€å–é›²ç«¯è³‡æ–™ä¸­...
        </div>

        <div id="share-content" style="display:none;">
            <p>é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œå°‡ä»Šå¤©çš„æˆæœè½‰æ›ç‚ºåœ–ç‰‡ï¼š</p>
            <div class="btn-action">
                <button onclick="generateImage()">ç”Ÿæˆåˆ†äº«åœ–ç‰‡</button>
            </div>

            <div id="share-card-wrapper">
                <div id="share-card">
                    <div class="card-header">
                        <h2>æˆ‘çš„ä»Šæ—¥æˆæœ</h2>
                        <p id="share-date"></p>
                    </div>

                    <h3>èº«é«”æ•¸æ“š</h3>
                    <div class="stat-grid" id="stat-grid-data">
                        <div class="stat-item"><div class="stat-label">é«”é‡</div><div class="stat-value" id="stat-weight">--</div></div>
                        <div class="stat-item"><div class="stat-label">é«”è„‚</div><div class="stat-value" id="stat-bodyfat">--</div></div>
                        <div class="stat-item"><div class="stat-label">éª¨éª¼è‚Œ</div><div class="stat-value" id="stat-muscle">--</div></div>
                    </div>

                    <h3>ä»Šæ—¥é£²é£Ÿç¸½è¨ˆ</h3>
                    <div class="stat-grid" id="macro-grid-data">
                        <div class="stat-item" style="background-color: #fce4ec;"><div class="stat-label">ç†±é‡</div><div class="stat-value" id="stat-cal">--</div></div>
                        <div class="stat-item" style="background-color: #e3f2fd;"><div class="stat-label">è›‹ç™½è³ª</div><div class="stat-value" id="stat-protein">--</div></div>
                        <div class="stat-item" style="background-color: #fffde7;"><div class="stat-label">ç¢³æ°´</div><div class="stat-value" id="stat-carbs">--</div></div>
                    </div>
                    
                    <h3>å®Œæˆè¨“ç·´</h3>
                    <div id="workout-log-list">
                        <div class="daily-log-item"><span>ğŸ’ª è¨“ç·´ç´€éŒ„è¼‰å…¥ä¸­...</span></div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px; font-size: 14px; color: #5c6bc0;">#å¥èº«è¿½è¹¤å™¨ #ProgressTracker</div>
                    <div style="text-align: center; font-size: 10px; color: #9fa8da;">Generated by Personal Fitness Tracker</div>
                </div>
            </div>
            
            <div id="image-preview">
                </div>
        </div>

    </div>

<script>
    // --- é€šç”¨æ—¥æœŸå‡½æ•¸ ---
    function getTodayKey() {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, '0');
        const day = String(today.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // --- é›²ç«¯è®€å– ---
    async function loadData(key) { 
        try { 
            const response = await fetch(`/api/getData?key=${key}`); 
            const data = await response.json(); 
            return data || (key === 'workoutLog' || key === 'dietLog' ? {} : []); 
        } catch (error) { 
            console.error(`Failed to load ${key}:`, error); 
            // å¦‚æœè®€å–å¤±æ•—ï¼Œæ‹‹å‡ºéŒ¯èª¤ï¼Œè®“ä¸»ç¨‹åºçŸ¥é“
            throw new Error(`è®€å–é›²ç«¯ ${key} å¤±æ•—ï¼`);
        } 
    }

    // --- æ•¸æ“šè™•ç† ---
    function processFitnessData(fitnessData) {
        const todayKey = getTodayKey();
        // å˜—è©¦ç²å–æœ€æ–°çš„æ—©ä¸Šå’Œæ™šä¸Šæ•¸æ“š
        const morningEntry = fitnessData.filter(d => d.date === todayKey && d.time === 'morning').pop();
        const eveningEntry = fitnessData.filter(d => d.date === todayKey && d.time === 'evening').pop();
        
        // å„ªå…ˆé¡¯ç¤ºæ—©ä¸Šæ•¸æ“šï¼Œå¦‚æœæ²’æœ‰ï¼Œå‰‡ä½¿ç”¨æ™šä¸Šæ•¸æ“šä½œç‚ºæœ€æ–°æ•¸æ“š
        const latestEntry = morningEntry || eveningEntry; 
        
        if (latestEntry) {
            return {
                weight: latestEntry.weight ? `${latestEntry.weight.toFixed(1)} kg` : '--',
                bodyfat: latestEntry.bodyfat ? `${latestEntry.bodyfat.toFixed(1)} %` : '--',
                muscleMass: latestEntry.muscleMass ? `${latestEntry.muscleMass.toFixed(1)} kg` : '--'
            };
        }
        return { weight: '--', bodyfat: '--', muscleMass: '--' };
    }

    function processDietData(dietLog) {
        const todayKey = getTodayKey();
        const logsForDay = dietLog[todayKey] || [];
        
        const totals = logsForDay.reduce((acc, item) => {
            acc.protein += item.protein;
            acc.carbs += item.carbs;
            acc.fat += item.fat;
            return acc;
        }, { protein: 0, carbs: 0, fat: 0 });

        const totalCalories = (totals.protein * 4) + (totals.carbs * 4) + (totals.fat * 9);
        
        return {
            cal: Math.round(totalCalories),
            protein: totals.protein.toFixed(1),
            carbs: totals.carbs.toFixed(1),
            fat: totals.fat.toFixed(1)
        };
    }

    function processWorkoutData(workoutLog) {
        const todayKey = getTodayKey();
        const dayKeys = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
        const todayDate = new Date();
        const todayInTaiwan = new Date(todayDate.toLocaleString("en-US", {timeZone: "Asia/Taipei"}));
        const currentDayKey = dayKeys[todayInTaiwan.getDay()];
        
        const logsForDay = workoutLog[currentDayKey] || {};
        const workoutList = [];
        
        // éæ­·ç•¶å¤©æ‰€æœ‰è¨“ç·´é …ç›® (åŒ…æ‹¬é è¨­å’Œè‡ªè¨‚)
        for (const exerciseName in logsForDay) {
            const sets = logsForDay[exerciseName][todayKey] || [];
            if (sets.length > 0) {
                 // çµ±è¨ˆçµ„æ•¸å’Œä»£è¡¨æ•¸æ“š
                const count = sets.length;
                const weightSets = sets.filter(s => s.type === 'weight');
                const timeSets = sets.filter(s => s.type === 'time');
                let summary = `å…± ${count} çµ„`;

                if (weightSets.length > 0) {
                     // æ‰¾åˆ°æœ€å¤§é‡é‡
                    const maxWeight = Math.max(...weightSets.map(s => s.weight));
                    summary = `${maxWeight}kg / å…± ${weightSets.length} çµ„`;
                } else if (timeSets.length > 0) {
                     // çµ±è¨ˆç¸½æ™‚é•·
                    const totalDuration = timeSets.reduce((sum, s) => sum + s.duration, 0);
                    summary = `${totalDuration} åˆ†é˜`;
                }

                workoutList.push({ name: exerciseName, summary });
            }
        }
        return workoutList;
    }

    // --- æ¸²æŸ“æ•¸æ“šåˆ°å¡ç‰‡ ---
    function renderCardData(data) {
        document.getElementById('share-date').textContent = getTodayKey();
        
        // èº«é«”æ•¸æ“š
        document.getElementById('stat-weight').textContent = data.fitness.weight;
        document.getElementById('stat-bodyfat').textContent = data.fitness.bodyfat;
        document.getElementById('stat-muscle').textContent = data.fitness.muscleMass;

        // é£²é£Ÿæ•¸æ“š
        document.getElementById('stat-cal').textContent = `${data.diet.cal} å¤§å¡`;
        document.getElementById('stat-protein').textContent = `${data.diet.protein} g`;
        document.getElementById('stat-carbs').textContent = `${data.diet.carbs} g`;
        
        // è¨“ç·´æ•¸æ“š
        const workoutListEl = document.getElementById('workout-log-list');
        workoutListEl.innerHTML = '';

        if (data.workout.length === 0) {
            workoutListEl.innerHTML = `<div class="daily-log-item"><span>ğŸ’ª ä»Šå¤©é‚„æ²’ç´€éŒ„è¨“ç·´å“¦ï¼</span></div>`;
            return;
        }

        data.workout.forEach(item => {
            const div = document.createElement('div');
            div.className = 'daily-log-item';
            div.innerHTML = `
                <span>${item.name}</span>
                <span class="log-macro">${item.summary}</span>
            `;
            workoutListEl.appendChild(div);
        });
    }

    // --- ä¸»åˆå§‹åŒ–ç¨‹åº ---
    async function initSharePage() {
        const loadingBox = document.getElementById('loading-box');
        const shareContent = document.getElementById('share-content');
        
        loadingBox.textContent = 'è®€å–é›²ç«¯è³‡æ–™ä¸­...';
        
        try {
            // ä¸€æ¬¡è®€å–æ‰€æœ‰å¿…è¦çš„æ•¸æ“š
            const fitnessData = await loadData('fitnessData');
            const dietLog = await loadData('dietLog');
            const workoutLog = await loadData('workoutLog');

            // è™•ç†æ•¸æ“š
            const fitnessResults = processFitnessData(fitnessData);
            const dietResults = processDietData(dietLog);
            const workoutResults = processWorkoutData(workoutLog);

            // æ¸²æŸ“å¡ç‰‡
            renderCardData({
                fitness: fitnessResults,
                diet: dietResults,
                workout: workoutResults
            });

            // é¡¯ç¤ºå…§å®¹ä¸¦éš±è—åŠ è¼‰æ¡†
            shareContent.style.display = 'block';
            loadingBox.style.display = 'none';

        } catch (error) {
            console.error(error);
            loadingBox.textContent = `è®€å–é›²ç«¯è³‡æ–™å¤±æ•—ï¼è«‹æª¢æŸ¥æ‚¨çš„ Vercel API æˆ–é‡æ–°æ•´ç†ã€‚éŒ¯èª¤: ${error.message}`;
            loadingBox.style.color = '#f44336';
            loadingBox.style.borderColor = '#f44336';
        }
    }

    // --- åœ–ç‰‡ç”Ÿæˆå‡½æ•¸ ---
    function generateImage() {
        const card = document.getElementById('share-card');
        const preview = document.getElementById('image-preview');
        preview.innerHTML = 'ç”Ÿæˆä¸­...';

        html2canvas(card, {
            backgroundColor: null, // ä¿æŒé€æ˜èƒŒæ™¯
            useCORS: true // å…è¨±è·¨åŸŸåœ–åƒï¼ˆå¦‚æœæœ‰ï¼‰
        }).then(canvas => {
            preview.innerHTML = '';
            const img = document.createElement('img');
            img.src = canvas.toDataURL('image/png');
            img.alt = 'æ¯æ—¥åˆ†äº«åœ–ç‰‡';
            preview.appendChild(img);
            
            // æä¾›ä¸‹è¼‰é€£çµ
            const downloadLink = document.createElement('a');
            downloadLink.href = img.src;
            downloadLink.download = `Fitness_Daily_Share_${getTodayKey()}.png`;
            downloadLink.textContent = 'é»æ“Šä¸‹è¼‰åœ–ç‰‡';
            downloadLink.style.display = 'block';
            downloadLink.style.marginTop = '15px';
            preview.appendChild(downloadLink);
            
            alert('åœ–ç‰‡å·²æˆåŠŸç”Ÿæˆï¼');
        }).catch(err => {
            console.error('åœ–ç‰‡ç”Ÿæˆå¤±æ•—:', err);
            preview.innerHTML = `<p style="color:red;">åœ–ç‰‡ç”Ÿæˆå¤±æ•—ã€‚è«‹å˜—è©¦é‡æ–°æ•´ç†é é¢ã€‚</p>`;
        });
    }

    document.addEventListener('DOMContentLoaded', initSharePage);
</script>
</body>
</html>
