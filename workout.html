<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šæ—¥èª²è¡¨ - å€‹äººå¥èº«è¿½è¹¤å™¨</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 900px; background-color: #fff; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #1a237e; }
        h1, h2 { border-bottom: 2px solid #3f51b5; padding-bottom: 10px; margin-top: 20px; }
        h1 { margin-top: 0; }
        nav a { text-decoration: none; flex-grow: 1; padding: 10px 15px; border: none; background-color: #e8eaf6; color: #3f51b5; cursor: pointer; border-radius: 5px; font-size: 16px; transition: background-color 0.3s; text-align: center; }
        nav a.active { background-color: #3f51b5; color: white; font-weight: bold; }
        #calendar-container { background-color: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 25px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .calendar-header button { background: none; border: none; cursor: pointer; font-size: 24px; color: #3f51b5; padding: 0 10px; }
        #calendar-title { font-size: 1.2em; font-weight: bold; color: #1a237e; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 5px; text-align: center; }
        .calendar-grid .day-name { font-weight: bold; font-size: 0.9em; color: #555; padding-bottom: 5px; }
        .calendar-grid .day { position: relative; padding: 8px 0; border-radius: 8px; transition: background-color 0.2s; border: 1px solid #ddd; }
        .calendar-grid .day.today { border: 2px solid #3f51b5; background-color: #e8eaf6; }
        .day .day-date { font-size: 1.2em; font-weight: bold; }
        .day .day-challenge-num { font-size: 0.8em; color: #888; }
        .day .checkmark { position: absolute; top: -2px; right: 2px; font-size: 1.5em; }
        .day .checkmark.green { color: #4caf50; }
        .day .checkmark.yellow { color: #FFC107; }
        .workout-nav { display: flex; flex-wrap: wrap; gap: 5px; border-bottom: 2px solid #eee; margin-bottom: 20px; }
        .workout-nav button { flex: 1; background-color: transparent; border: none; padding: 12px 5px; font-size: 14px; color: #555; border-bottom: 3px solid transparent; border-radius: 0; margin: 0; }
        .workout-nav button.active { color: #3f51b5; border-bottom-color: #3f51b5; font-weight: bold; }
        .workout-day-content { display: none; } .workout-day-content.active { display: block; }
        .exercise-card { background-color: #fdfdfd; border: 1px solid #eaeaea; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .exercise-card h3 { margin-top: 0; margin-bottom: 10px; font-size: 1.2em; color: #333; display: flex; justify-content: space-between; align-items: center; }
        .delete-custom-btn { color: #f44336; font-size: 1.2em; font-weight: bold; cursor: pointer; padding: 0 5px; }
        .last-log { background-color: #f0f2f5; border-radius: 5px; padding: 8px; margin-bottom: 15px; font-size: 0.9em; color: #666; }
        .last-log strong { color: #1a237e; }
        .sets-log-today { margin-top: 10px; font-size: 0.95em; }
        .set-item { display: flex; align-items: center; gap: 10px; padding: 5px 0; }
        .set-item span { background-color: #e8eaf6; padding: 3px 8px; border-radius: 12px; font-weight: bold; }
        .set-item .delete-set-btn { background: #ffcdd2; color: #c62828; border: none; border-radius: 50%; cursor: pointer; width: 24px; height: 24px; font-weight: bold; line-height: 24px; padding: 0; }
        .input-set-group { display: flex; flex-wrap: wrap; gap: 10px; align-items: center; border-top: 1px dashed #ccc; padding-top: 15px; margin-top: 15px; }
        .input-set-group input { width: 80px; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; flex-grow: 1; }
        .input-set-group button { padding: 8px 15px; font-size: 14px; background-color: #4caf50; color: white; border: none; border-radius: 5px; cursor: pointer;}
        .rest-day-message { text-align: center; padding: 20px; font-size: 1.2em; color: #888; }
        .add-exercise-form { display: flex; gap: 10px; margin-top: 25px; padding: 15px; background-color: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 8px; }
        .add-exercise-form input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 16px; }
        .add-exercise-form button { background-color: #2196F3; white-space: nowrap; }
    </style>
</head>
<body>
    <div class="container">
        <h1>å€‹äººå¥èº«è¿½è¹¤å™¨</h1>
        <nav>
            <a href="index.html">æ•¸æ“šè¿½è¹¤</a>
            <a href="workout.html" class="active">ä»Šæ—¥èª²è¡¨</a>
            <a href="diet.html">é£²é£Ÿç´€éŒ„</a>
        </nav>

        <div id="page-checklist">
            <h2>æˆ‘çš„èª²è¡¨</h2>
            <div id="calendar-container">
                <div class="calendar-header">
                    <button id="prev-week-btn">â€¹</button>
                    <h3 id="calendar-title"></h3>
                    <button id="next-week-btn">â€º</button>
                </div>
                <div class="calendar-grid" id="calendar-weekdays"></div>
                <div class="calendar-grid" id="calendar-days"></div>
            </div>
            <div class="workout-nav" id="workout-nav"></div>
            <div id="workout-content-container"></div>
        </div>
    </div>

<script>
    const workoutPlan = {
        monday: { dayName: "æ˜ŸæœŸä¸€ï¼šèƒ¸éƒ¨è¨“ç·´", exercises: ["åœ°æ¿å•éˆ´èƒ¸æ¨", "ä¸Šæ–œå•éˆ´èƒ¸æ¨ (åœ°æ¿å¼)", "å•éˆ´Squeezeæ¡æ¨", "è‡€æ©‹å¼å•éˆ´èƒ¸æ¨", "çª„è·/é‘½çŸ³ä¼åœ°æŒºèº«"] },
        tuesday: { dayName: "æ˜ŸæœŸäºŒï¼šèƒŒéƒ¨è¨“ç·´", exercises: ["å–®è‡‚å•éˆ´åˆ’èˆ¹", "å•éˆ´ä¸Šæ‹‰ (Dumbbell Pullover)", "ä¿¯èº«å•éˆ´åˆ’èˆ¹ (é›™æ‰‹)", "é³¥ç‹—å¼"] },
        wednesday: { dayName: "æ˜ŸæœŸä¸‰ï¼šä¼‘æ¯æ—¥", exercises: [] }, 
        thursday: { dayName: "æ˜ŸæœŸå››ï¼šè…¿éƒ¨è¨“ç·´", exercises: ["ä¿åŠ åˆ©äºåˆ†è…¿è¹²", "é«˜è…³æ¯ç®±å¼æ·±è¹²", "å•éˆ´è² é‡è‡€æ©‹", "ç«™å§¿å•éˆ´æè¸µ"] },
        friday: { dayName: "æ˜ŸæœŸäº”ï¼šè‚©éƒ¨è¨“ç·´", exercises: ["åå§¿å•éˆ´è‚©æ¨", "è¶…ç´šçµ„ï¼šåå§¿å•éˆ´å´å¹³èˆ‰ + åå§¿å•éˆ´å‰å¹³èˆ‰", "ä¿¯èº«å•éˆ´åå‘é£›é³¥", "å•éˆ´è³è‚©"] },
        saturday: { dayName: "æ˜ŸæœŸå…­ï¼šæ‰‹è‡‚è¨“ç·´", exercises: ["è¶…ç´šçµ„ï¼šå•éˆ´äºŒé ­å½èˆ‰ + åå§¿éé ­ä¸‰é ­ä¼¸å±•", "è¶…ç´šçµ„ï¼šå•éˆ´éšå¼å½èˆ‰ + å•éˆ´é ¸å¾Œè‡‚å±ˆä¼¸", "è¶…ç´šçµ„ï¼šé›†ä¸­å½èˆ‰ + çª„è·ä¼åœ°æŒºèº«"] },
        sunday: { dayName: "æ˜ŸæœŸæ—¥ï¼šä¼‘æ¯æ—¥", exercises: [] },
    };
    const dayKeys = ["sunday", "monday", "tuesday", "wednesday", "thursday", "friday", "saturday"];
    let workoutLog = {};
    let lastWorkoutInputs = JSON.parse(localStorage.getItem('lastWorkoutInputs')) || {};
    let currentCalendarDate = new Date();

    async function saveData(key, value) { try { await fetch('/api/setData', { method: 'POST', body: JSON.stringify({ key, value }) }); } catch (error) { console.error(`Failed to save ${key}:`, error); alert(`${key} å„²å­˜å¤±æ•—ï¼`); } }
    async function loadData(key) { 
        try { 
            const response = await fetch(`/api/getData?key=${key}`); 
            const data = await response.json(); 
            // æ ¸å¿ƒä¿®æ­£ï¼šç¢ºä¿è¿”å›çš„ data æ˜¯ç‰©ä»¶ï¼Œè€Œä¸æ˜¯å­—ä¸²
            return data && typeof data === 'string' ? JSON.parse(data) : (data || {});
        } catch (error) { 
            console.error(`Failed to load ${key}:`, error); 
            return {}; 
        } 
    }
    function saveLastWorkoutInputs() { localStorage.setItem('lastWorkoutInputs', JSON.stringify(lastWorkoutInputs)); }
    
    // æ ¸å¿ƒæ™‚å€ä¿®æ­£å‡½æ•¸ï¼šç²å–å°ç£æ™‚å€çš„ YYYY-MM-DD
    function getTodayKey() {
        const today = new Date();
        const dateParts = today.toLocaleString('en-CA', { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit' });
        return dateParts.replace(/\//g, '-');
    }

    function isWorkoutCompletedOnDate(dateString) {
        const date = new Date(dateString + 'T00:00:00');
        const dayOfWeekKey = dayKeys[date.getDay()];
        const planForDay = workoutPlan[dayOfWeekKey];
        
        if (!planForDay || planForDay.exercises.length === 0) { return false; }
        
        for (const exerciseName of planForDay.exercises) {
            let hasLog = false;
            if (
                workoutLog[dayOfWeekKey] && 
                workoutLog[dayOfWeekKey][exerciseName] && 
                workoutLog[dayOfWeekKey][exerciseName][dateString] && 
                workoutLog[dayOfWeekKey][exerciseName][dateString].length > 0
            ) {
                hasLog = true;
            }
            if (!hasLog) { return false; } 
        }
        return true; 
    }
    
    function hasAnyWorkoutOnDate(dateString) {
        for (const key of dayKeys) {
            if (workoutLog[key]) {
                for (const exName in workoutLog[key]) {
                    if (workoutLog[key][exName][dateString] && workoutLog[key][exName][dateString].length > 0) {
                        return true;
                    }
                }
            }
        }
        return false;
    }
    
    function renderWorkoutCalendar(displayDate) {
        const titleEl = document.getElementById('calendar-title');
        const daysContainer = document.getElementById('calendar-days');
        const weekdaysContainer = document.getElementById('calendar-weekdays');
        daysContainer.innerHTML = ''; weekdaysContainer.innerHTML = '';
        const weekdays = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'æ—¥'];
        weekdays.forEach(day => { weekdaysContainer.innerHTML += `<div class="day-name">${day}</div>`; });
        
        let dayOfWeek = displayDate.getDay(); if (dayOfWeek === 0) dayOfWeek = 7;
        const monday = new Date(displayDate); monday.setDate(displayDate.getDate() - (dayOfWeek - 1)); monday.setHours(0, 0, 0, 0);
        const sunday = new Date(monday); sunday.setDate(monday.getDate() + 6);
        titleEl.textContent = `æœ¬é€±è¨“ç·´ç´€éŒ„ (${monday.getMonth()+1}/${monday.getDate()} - ${sunday.getMonth()+1}/${sunday.getDate()})`;

        const today = new Date(); today.setHours(0, 0, 0, 0); 
        const todayString = getTodayKey(); 
        const CHALLENGE_START_DATE = new Date('2025-10-20T00:00:00');

        for (let i = 0; i < 7; i++) {
            const currentDate = new Date(monday); currentDate.setDate(monday.getDate() + i);
            
            // æ ¸å¿ƒä¿®æ­£ï¼šçµ±ä¸€ä½¿ç”¨ TW æ—¥æœŸå­—ä¸²ä¾†ä½œç‚ºéµå’Œæ¯”è¼ƒ
            const dateString = currentDate.toLocaleString('en-CA', { timeZone: 'Asia/Taipei', year: 'numeric', month: '2-digit', day: '2-digit' }).replace(/\//g, '-');
            
            const diffTime = currentDate - CHALLENGE_START_DATE;
            const challengeDayNum = Math.floor(diffTime / (1000 * 60 * 60 * 24)) + 1;
            const challengeDayText = (challengeDayNum > 0 && challengeDayNum <= 100) ? `ç¬¬ ${challengeDayNum} å¤©` : (challengeDayNum < 1 ? 'æŒ‘æˆ°å‰' : 'æŒ‘æˆ°å¾Œ');
            
            const dayDiv = document.createElement('div'); dayDiv.className = 'day';
            if (dateString === todayString) { dayDiv.classList.add('today'); } 
            dayDiv.innerHTML = `<div class="day-date">${currentDate.getDate()}</div><div class="day-challenge-num">${challengeDayText}</div>`;
            
            if (currentDate <= today && currentDate >= CHALLENGE_START_DATE) {
                const planForDay = workoutPlan[dayKeys[currentDate.getDay()]];
                
                if (isWorkoutCompletedOnDate(dateString)) {
                    dayDiv.innerHTML += `<span class="checkmark green">âœ“</span>`;
                } else if (planForDay && planForDay.exercises.length === 0) {
                    if (hasAnyWorkoutOnDate(dateString)) {
                        dayDiv.innerHTML += `<span class="checkmark green">âœ“</span>`;
                    } else {
                        dayDiv.innerHTML += `<span class="checkmark yellow">ğŸŸ¡</span>`;
                    }
                }
            }
            daysContainer.appendChild(dayDiv);
        }
    }

    function initWorkoutPage() {
        renderWorkoutCalendar(currentCalendarDate);
        document.getElementById('prev-week-btn').onclick = () => { currentCalendarDate.setDate(currentCalendarDate.getDate() - 7); renderWorkoutCalendar(currentCalendarDate); };
        document.getElementById('next-week-btn').onclick = () => { currentCalendarDate.setDate(currentCalendarDate.getDate() + 7); renderWorkoutCalendar(currentCalendarDate); };
        const navContainer = document.getElementById('workout-nav');
        const contentContainer = document.getElementById('workout-content-container');
        navContainer.innerHTML = ''; contentContainer.innerHTML = '';
        Object.entries(workoutPlan).forEach(([key, value]) => {
            const btn = document.createElement('button'); btn.id = `btn-workout-${key}`; btn.textContent = value.dayName.split('ï¼š')[0]; btn.onclick = () => showWorkoutDay(key); navContainer.appendChild(btn);
            const contentDiv = document.createElement('div'); contentDiv.id = `content-workout-${key}`; contentDiv.className = 'workout-day-content'; contentContainer.appendChild(contentDiv);
        });
        const todayDate = new Date(); 
        const currentDayKey = dayKeys[todayDate.getDay()];
        showWorkoutDay(currentDayKey);
    }
    
    function showWorkoutDay(dayKey) {
        document.querySelectorAll('.workout-nav button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.workout-day-content').forEach(div => div.classList.remove('active'));
        document.getElementById(`btn-workout-${dayKey}`).classList.add('active');
        const contentDiv = document.getElementById(`content-workout-${dayKey}`);
        contentDiv.classList.add('active');
        renderDayContent(dayKey, contentDiv);
    }
    
    function renderDayContent(dayKey, container) {
        container.innerHTML = '';
        const dayData = workoutPlan[dayKey];
        const todayKey = getTodayKey();
        const exercisesToShow = new Set(dayData.exercises);
        if (workoutLog[dayKey]) { for (const exName in workoutLog[dayKey]) { if (workoutLog[dayKey][exName][todayKey]) { exercisesToShow.add(exName); } } }
        const exerciseList = Array.from(exercisesToShow);
        
        if (exerciseList.length === 0 && dayData.exercises.length === 0) { container.innerHTML = `<div class="rest-day-message">ä»Šå¤©æ˜¯ä¼‘æ¯æ—¥ï¼Œä½†æ‚¨ä»å¯ä»¥æ–°å¢æ´»å‹•ç´€éŒ„ã€‚</div>`; }
        
        exerciseList.forEach((exerciseName) => {
            const uniqueId = exerciseName.replace(/[\s\W]/g, '-');
            const isCustom = !dayData.exercises.includes(exerciseName);
            if (!workoutLog[dayKey]) workoutLog[dayKey] = {};
            if (!workoutLog[dayKey][exerciseName]) workoutLog[dayKey][exerciseName] = {};
            const exerciseLogs = workoutLog[dayKey][exerciseName];
            const todayLogs = exerciseLogs[todayKey] || [];
            const lastInput = lastWorkoutInputs[exerciseName] || {};
            const logDates = Object.keys(exerciseLogs).filter(date => date !== todayKey).sort().reverse();
            let lastLogHTML = '<strong>ä¸Šæ¬¡ç´€éŒ„:</strong> å°šç„¡ç´€éŒ„';
            if (logDates.length > 0) {
                const lastDate = logDates[0];
                const lastSets = exerciseLogs[lastDate].map(set => (set.type === 'time') ? `${set.duration} åˆ†é˜` : `${set.weight}kg x ${set.reps}æ¬¡`).join(' / ');
                lastLogHTML = `<strong>ä¸Šæ¬¡ç´€éŒ„ (${lastDate}):</strong> ${lastSets}`;
            }
            
            // æ ¸å¿ƒä¿®æ­£: è®“è¼¸å…¥æ¡†ä½¿ç”¨å”¯ä¸€çš„ ID
            let inputGroupsHTML = `<div class="input-set-group"><input type="number" id="weight-${dayKey}-${uniqueId}" placeholder="é‡é‡(kg)" value="${lastInput.weight || ''}"><input type="number" id="reps-${dayKey}-${uniqueId}" placeholder="æ¬¡æ•¸" value="${lastInput.reps || ''}"><button onclick="addSet('${dayKey}', '${exerciseName}', 'weight', '${uniqueId}')">æ–°å¢çµ„æ•¸</button></div>`;
            if (isCustom) { inputGroupsHTML += `<div class="input-set-group"><input type="number" id="time-${dayKey}-${uniqueId}" placeholder="æ™‚é–“(åˆ†é˜)" value="${lastInput.duration || ''}"><button onclick="addSet('${dayKey}', '${exerciseName}', 'time', '${uniqueId}')">æ–°å¢æ™‚é–“</button></div>`; }

            const card = document.createElement('div');
            card.className = 'exercise-card';
            const deleteBtnHTML = isCustom ? `<span class="delete-custom-btn" onclick="deleteCustomExercise('${dayKey}', '${exerciseName}')">Ã—</span>` : '';
            // æ ¸å¿ƒä¿®æ­£: è®“ sets-log-today ä½¿ç”¨å”¯ä¸€çš„ ID
            card.innerHTML = `<h3><span>${exerciseName} ${isCustom ? '<span style="color:#ff9800; font-size:0.8em;">(è‡ªè¨‚)</span>' : ''}</span> ${deleteBtnHTML}</h3><div class="last-log">${lastLogHTML}</div><div class="sets-log-today" id="sets-today-${uniqueId}"></div>${inputGroupsHTML}`;
            container.appendChild(card);
            renderTodaySets(dayKey, exerciseName, uniqueId, todayLogs);
        });

        const addForm = document.createElement('div');
        addForm.className = 'add-exercise-form';
        addForm.innerHTML = `<input type="text" id="new-exercise-input-${dayKey}" placeholder="è¼¸å…¥æ–°çš„é‹å‹•åç¨±..."><button onclick="addCustomExercise('${dayKey}')">âœš æ–°å¢è‡ªè¨‚é …ç›®</button>`;
        container.appendChild(addForm);
    }

    // æ ¸å¿ƒä¿®æ­£: renderTodaySets æ¥æ”¶ uniqueId
    function renderTodaySets(dayKey, exerciseName, uniqueId, sets) {
        const container = document.getElementById(`sets-today-${uniqueId}`);
        container.innerHTML = '<strong>ä»Šæ—¥ç´€éŒ„:</strong>';
        if (!sets || sets.length === 0) { container.innerHTML += ' å°šæœªè¨˜éŒ„'; return; }
        sets.forEach((set, setIndex) => {
            const setEl = document.createElement('div');
            setEl.className = 'set-item';
            const setText = (set.type === 'time') ? `${set.duration} åˆ†é˜` : `${set.weight} kg x ${set.reps} æ¬¡`;
            setEl.innerHTML = `<span>ç¬¬ ${setIndex + 1} çµ„</span><div>${setText}</div><button class="delete-set-btn" onclick="deleteSet('${dayKey}', '${exerciseName}', ${setIndex})">X</button>`;
            container.appendChild(setEl);
        });
    }

    async function addCustomExercise(dayKey) {
        const input = document.getElementById(`new-exercise-input-${dayKey}`);
        const newExerciseName = input.value.trim();
        if (!newExerciseName) { alert('è«‹è¼¸å…¥é‹å‹•åç¨±ï¼'); return; }
        const dayData = workoutPlan[dayKey];
        if (dayData.exercises.includes(newExerciseName)) { alert('æ­¤é …ç›®å·²åœ¨æ‚¨çš„é è¨­èª²è¡¨ä¸­ï¼'); return; }
        const todayKey = getTodayKey();
        if (!workoutLog[dayKey]) workoutLog[dayKey] = {};
        if (!workoutLog[dayKey][newExerciseName]) workoutLog[dayKey][newExerciseName] = {};
        if (!workoutLog[dayKey][newExerciseName][todayKey]) { workoutLog[dayKey][newExerciseName][todayKey] = []; }
        renderDayContent(dayKey, document.getElementById(`content-workout-${dayKey}`));
        input.value = '';
    }

    async function deleteCustomExercise(dayKey, exerciseName) {
        if (confirm(`ç¢ºå®šè¦å¾ä»Šå¤©ç§»é™¤ "${exerciseName}" é€™å€‹é …ç›®å—ï¼Ÿ(åªæœƒç§»é™¤ä»Šå¤©çš„ç´€éŒ„)`)) {
            const todayKey = getTodayKey();
            if (workoutLog[dayKey] && workoutLog[dayKey][exerciseName] && workoutLog[dayKey][exerciseName][todayKey]) {
                delete workoutLog[dayKey][exerciseName][todayKey];
                await saveData('workoutLog', workoutLog);
            }
            renderDayContent(dayKey, document.getElementById(`content-workout-${dayKey}`));
            renderWorkoutCalendar(currentCalendarDate);
        }
    }
    
    // æ ¸å¿ƒä¿®æ­£: addSet æ¥æ”¶ uniqueId
    async function addSet(dayKey, exerciseName, type) {
        const uniqueId = exerciseName.replace(/[\s\W]/g, '-');
        const todayKey = getTodayKey();
        const wasCompleted = isWorkoutCompletedOnDate(todayKey);
        const wasActiveRest = hasAnyWorkoutOnDate(todayKey);
        if (!workoutLog[dayKey]) workoutLog[dayKey] = {};
        if (!workoutLog[dayKey][exerciseName]) workoutLog[dayKey][exerciseName] = {};
        if (!workoutLog[dayKey][exerciseName][todayKey]) { workoutLog[dayKey][exerciseName][todayKey] = []; }

        let newSet;
        if (type === 'weight') {
            // æ ¸å¿ƒä¿®æ­£: ä½¿ç”¨ uniqueId ç²å–æ­£ç¢ºçš„è¼¸å…¥æ¡† ID
            const weightInput = document.getElementById(`weight-${dayKey}-${uniqueId}`);
            const repsInput = document.getElementById(`reps-${dayKey}-${uniqueId}`);
            const weight = parseFloat(weightInput.value);
            const reps = parseInt(repsInput.value);
            if (isNaN(weight) || isNaN(reps) || weight < 0 || reps <= 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„é‡é‡å’Œæ¬¡æ•¸ï¼'); return; }
            newSet = { type: 'weight', weight, reps };
            lastWorkoutInputs[exerciseName] = { ...lastWorkoutInputs[exerciseName], weight, reps };
        } else { // type === 'time'
            const timeInput = document.getElementById(`time-${dayKey}-${uniqueId}`);
            const duration = parseInt(timeInput.value);
            if (isNaN(duration) || duration <= 0) { alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ™‚é–“(åˆ†é˜)ï¼'); return; }
            newSet = { type: 'time', duration };
            lastWorkoutInputs[exerciseName] = { ...lastWorkoutInputs[exerciseName], duration };
        }
        
        workoutLog[dayKey][exerciseName][todayKey].push(newSet);
        saveLastWorkoutInputs();
        await saveData('workoutLog', workoutLog);
        
        const isNowCompleted = isWorkoutCompletedOnDate(todayKey);
        const isNowActiveRest = hasAnyWorkoutOnDate(todayKey);

        if ((!wasCompleted && isNowCompleted) || (!wasActiveRest && isNowActiveRest)) {
            renderWorkoutCalendar(currentCalendarDate);
        }
        // æ ¸å¿ƒä¿®æ­£: åªåˆ·æ–°ç•¶å‰åˆ†é çš„å…§å®¹
        renderDayContent(dayKey, document.getElementById(`content-workout-${dayKey}`)); 
    }

    async function deleteSet(dayKey, exerciseName, setIndex) {
        const todayKey = getTodayKey();
        const wasCompleted = isWorkoutCompletedOnDate(todayKey);
        const wasActiveRest = hasAnyWorkoutOnDate(todayKey);

        workoutLog[dayKey][exerciseName][todayKey].splice(setIndex, 1);
        await saveData('workoutLog', workoutLog);

        const isNowCompleted = isWorkoutCompletedOnDate(todayKey);
        const isNowActiveRest = hasAnyWorkoutOnDate(todayKey);

        if ((wasCompleted && !isNowCompleted) || (wasActiveRest && !isNowActiveRest)) {
            renderWorkoutCalendar(currentCalendarDate);
        }
        renderDayContent(dayKey, document.getElementById(`content-workout-${dayKey}`));
    }

    document.addEventListener('DOMContentLoaded', async () => {
        workoutLog = await loadData('workoutLog');
        initWorkoutPage();
    });
</script>
</body>
</html>
