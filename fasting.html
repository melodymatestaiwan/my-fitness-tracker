<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>間歇性斷食計時器</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }
        .container {
            width: 100%;
            max-width: 900px;
            background-color: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1, h2 {
            color: #1a237e;
            border-bottom: 2px solid #3f51b5;
            padding-bottom: 10px;
            margin-top: 20px;
        }
        h1 { margin-top: 0; }
        nav { margin-bottom: 20px; display: flex; flex-wrap: wrap; gap: 5px; }
        nav a { text-decoration: none; flex-grow: 1; padding: 10px 15px; border: none; background-color: #e8eaf6; color: #3f51b5; cursor: pointer; border-radius: 5px; font-size: 16px; transition: background-color 0.3s; text-align: center; }
        nav a.active { background-color: #3f51b5; color: white; font-weight: bold; }
        
        #timer-display {
            text-align: center;
            margin: 40px 0;
        }
        #status-text {
            font-size: 1.5em;
            font-weight: bold;
            color: #3f51b5;
            margin-bottom: 10px;
        }
        #countdown-timer {
            font-size: 4em;
            font-weight: 700;
            color: #1a237e;
        }
        #time-info {
            font-size: 1em;
            color: #555;
        }

        /* 進度條容器 */
        .progress-circle-container {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 0 auto 30px;
        }
        .progress-circle {
            width: 100%;
            height: 100%;
            transform: rotate(-90deg); /* 讓起點在最上方 */
        }
        .progress-circle .background {
            fill: none;
            stroke: #e0e0e0;
            stroke-width: 15;
        }
        .progress-circle .progress {
            fill: none;
            stroke: #4caf50;
            stroke-width: 15;
            stroke-linecap: round;
            transition: stroke-dashoffset 0.5s linear;
        }
        .timer-text-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        /* 控制區塊 */
        .controls {
            text-align: center;
            margin-bottom: 20px;
        }
        .controls button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background-color 0.3s;
        }
        #start-btn { background-color: #4caf50; color: white; }
        #stop-btn { background-color: #f44336; color: white; }
        #edit-btn { background-color: #2196F3; color: white; }
        /* AI Button */
        #advice-btn { background-color: #9c27b0; color: white; }
        #motivation-btn { background-color: #00bcd4; color: white; } /* New AI button color */

        /* 模式選擇 */
        #mode-selector {
            margin-bottom: 20px;
            text-align: center;
        }
        #mode-selector select {
            padding: 10px;
            border-radius: 8px;
            font-size: 16px;
        }

        /* AI 輸出區塊 */
        #ai-control-group {
            max-width: 600px;
            margin: 20px auto;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #fafafa;
        }
        #motivation-input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        #motivation-input-group input {
            flex-grow: 1;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        #advice-output {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #9c27b0;
            border-radius: 8px;
            background-color: #f3e5f5;
            text-align: left;
            min-height: 50px;
        }
        #motivation-output {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #00bcd4;
            border-radius: 8px;
            background-color: #e0f7fa;
            text-align: left;
            min-height: 50px;
        }
        #advice-output strong { color: #9c27b0; }
        #motivation-output strong { color: #00bcd4; }
        
        /* 歷史紀錄 */
        #history-table-container {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        #history-table {
            width: 100%;
            border-collapse: collapse;
        }
        #history-table th, #history-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        #history-table th { background-color: #e8eaf6; color: #3f51b5; position: sticky; top: 0; }
        
    </style>
</head>
<body>
    <div class="container">
        <h1>個人健身追蹤器</h1>
        <nav>
            <a href="index.html">數據追蹤</a>
            <a href="workout.html">今日課表</a>
            <a href="diet.html">飲食紀錄</a>
            <a href="fasting.html" class="active">間歇性斷食</a>
        </nav>

        <h2>斷食計時器</h2>

        <div id="mode-selector">
            <label for="fasting-mode">選擇斷食模式:</label>
            <select id="fasting-mode" onchange="updateMode()">
                <option value="16:8">16:8 (斷食16小時)</option>
                <option value="18:6">18:6 (斷食18小時)</option>
                <option value="20:4">20:4 (斷食20小時)</option>
                <option value="14:10">14:10 (斷食14小時)</option>
            </select>
        </div>

        <div id="timer-display">
            <div class="progress-circle-container">
                <svg viewBox="0 0 100 100" class="progress-circle">
                    <circle class="background" cx="50" cy="50" r="45"></circle>
                    <circle class="progress" id="progress-ring" cx="50" cy="50" r="45"></circle>
                </svg>
                <div class="timer-text-overlay">
                    <div id="status-text">準備開始</div>
                    <div id="countdown-timer">00:00:00</div>
                    <div id="time-info">--</div>
                </div>
            </div>

            <div class="controls">
                <button id="start-btn" onclick="startFasting()">開始斷食</button>
                <button id="stop-btn" onclick="stopFasting()" style="display:none;">結束/重設</button>
                <button id="edit-btn" onclick="editTime()">編輯時間</button>
            </div>
            
            <!-- AI 控制區塊 -->
            <div id="ai-control-group">
                <div id="motivation-input-group">
                    <input type="text" id="fasting-goal-input" placeholder="輸入今日斷食目標 (e.g. 專注工作, 避免飢餓)">
                    <button id="motivation-btn" onclick="getMotivation()">✨ 激勵與策略</button>
                </div>
                <div id="motivation-output">點擊「激勵與策略」，讓 AI 為您生成執行策略。</div>
                <button id="advice-btn" onclick="getFastingAdvice()">✨ 獲取破戒建議</button>
                <div id="advice-output">點擊「獲取破戒建議」，讓 AI 為您生成斷食結束後的飲食建議。</div>
            </div>
            
        </div>
        
        <h2>歷史斷食紀錄</h2>
        <div id="history-table-container">
            <table id="history-table">
                <thead>
                    <tr>
                        <th>日期</th>
                        <th>模式</th>
                        <th>開始時間</th>
                        <th>結束時間</th>
                        <th>總時長</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="history-tbody">
                    <tr><td colspan="6">尚無紀錄...</td></tr>
                </tbody>
            </table>
        </div>

    </div>

<script>
    // --- Configuration ---
    const TIME_OFFSET = 8 * 60 * 60 * 1000; // TW time zone offset (UTC+8)
    const modes = {
        '16:8': { fast: 16, eat: 8, name: '16小時斷食' },
        '18:6': { fast: 18, eat: 6, name: '18小時斷食' },
        '20:4': { fast: 20, eat: 4, name: '20小時斷食' },
        '14:10': { fast: 14, eat: 10, name: '14小時斷食' }
    };
    
    // --- State Variables ---
    let timerInterval;
    let isFasting = false;
    let modeKey = '16:8'; 
    let currentMode = modes[modeKey];
    let fastingState = {}; 
    let historyLog = [];

    // --- DOM Elements ---
    const statusTextEl = document.getElementById('status-text');
    const timerEl = document.getElementById('countdown-timer');
    const timeInfoEl = document.getElementById('time-info');
    const progressRingEl = document.getElementById('progress-ring');
    const startBtn = document.getElementById('start-btn');
    const stopBtn = document.getElementById('stop-btn');
    const historyTbody = document.getElementById('history-tbody');
    const adviceOutputEl = document.getElementById('advice-output');
    const adviceBtn = document.getElementById('advice-btn');
    const motivationOutputEl = document.getElementById('motivation-output');
    const motivationBtn = document.getElementById('motivation-btn');
    const goalInputEl = document.getElementById('fasting-goal-input');


    const radius = 45;
    const circumference = 2 * Math.PI * radius;
    progressRingEl.style.strokeDasharray = `${circumference} ${circumference}`;
    progressRingEl.style.strokeDashoffset = circumference;
    
    // --- Helper Functions ---
    async function loadData(key) { 
        try { 
            const url = `${window.location.origin}/api/getData?key=${key}`;
            const response = await fetch(url); 
            
            if (!response.ok) {
                 console.error(`API status error for ${key}: ${response.status}`);
                 return {}; 
            }
            
            const text = await response.text();
            if (!text) return {}; 

            return JSON.parse(text) || {}; 
        } catch (error) { 
            console.error(`Failed to load ${key}:`, error); 
            return {}; 
        } 
    }

    async function saveData(key, value) { 
        try { 
            const url = `${window.location.origin}/api/setData`;
            await fetch(url, { 
                method: 'POST', 
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ key, value }) 
            }); 
            return true;
        } catch (error) { 
            console.error(`Failed to save ${key}:`, error); 
            return false;
        } 
    }

    function getFormattedTime(timestamp) {
        // 格式化為台灣時間 (HH:MM:SS)
        return new Date(timestamp).toLocaleTimeString('zh-TW', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            hour12: false,
            timeZone: 'Asia/Taipei'
        });
    }

    function getFormattedDate(timestamp) {
        // 格式化為台灣日期 (YYYY-MM-DD)
        return new Date(timestamp).toLocaleDateString('zh-TW', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            timeZone: 'Asia/Taipei'
        }).replace(/\//g, '-').split(' ')[0];
    }
    
    function setProgress(percent) {
        // 核心修正：計算 offset，使其從 0% 遞增 (順時針)
        const offset = circumference - percent / 100 * circumference;
        progressRingEl.style.strokeDashoffset = offset;
    }

    // --- Core Timer Logic ---

    function updateTimer() {
        const now = Date.now();
        const { start, status, mode } = fastingState;
        
        if (!start || !status || !modes[mode]) {
            resetTimerDisplay();
            return;
        }

        const modeData = modes[mode];
        const fastDurationMs = modeData.fast * 3600000; // 斷食總時長 (毫秒)
        const elapsedSinceStart = now - start;

        // 判斷當前狀態 (斷食超時後，保持在斷食狀態，不進入進食期)
        let phaseDuration, phaseName, phaseColor;
        let phaseEndTimestamp;
        
        if (status === 'fasting') {
            phaseDuration = fastDurationMs;
            phaseEndTimestamp = start + fastDurationMs;
            
            if (elapsedSinceStart < fastDurationMs) {
                // 正在斷食期，還未完成
                phaseName = '斷食中 (Fasting)';
                phaseColor = '#f44336';
                timeSincePhaseStart = elapsedSinceStart;
            } else {
                // 超額斷食
                phaseName = '超額斷食中 (Overtime)';
                phaseColor = '#9c27b0'; // 紫色表示超時
                timeSincePhaseStart = elapsedSinceStart; 
                phaseDuration = elapsedSinceStart; // 讓進度條保持 100% 滿
            }

        } else if (status === 'eating') {
            // 正在進食期 (這塊邏輯在使用者點擊 "開始進食" 按鈕後才會發生)
            phaseDuration = modeData.eat * 3600000;
            phaseEndTimestamp = fastingState.eatingStart + phaseDuration;
            
            const timeSinceEatingStart = now - fastingState.eatingStart;

            if (timeSinceEatingStart < phaseDuration) {
                phaseName = '進食中 (Eating)';
                phaseColor = '#4caf50';
                timeSincePhaseStart = timeSinceEatingStart;
            } else {
                 // 進食期結束，應該提示開始新的斷食，但我們保持計時器不動，直到使用者操作
                 phaseName = '進食窗口已關閉';
                 phaseColor = '#3f51b5';
                 // 保持時間和進度條為 100%，直到使用者手動開始新的斷食
                 timeSincePhaseStart = phaseDuration; 
            }
        }
        
        // Time Display Calculation: 顯示已過時間 (遞增)
        const totalSeconds = Math.floor(timeSincePhaseStart / 1000);
        const hours = Math.floor(totalSeconds / 3600);
        const minutes = Math.floor((totalSeconds % 3600) / 60);
        const seconds = totalSeconds % 60;
        
        // Render Updates
        statusTextEl.textContent = phaseName;
        statusTextEl.style.color = phaseColor;
        progressRingEl.style.stroke = phaseColor;
        // 核心修正：計時器顯示已過時間
        timerEl.textContent = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        
        let endHourDisplay;
        if (status === 'fasting' && elapsedSinceStart < fastDurationMs) {
            endHourDisplay = new Date(phaseEndTimestamp).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Taipei' });
            timeInfoEl.textContent = `斷食結束於 ${endHourDisplay}`;
        } else if (status === 'fasting') {
            timeInfoEl.textContent = '已超過目標斷食時長！';
        } else {
            endHourDisplay = new Date(phaseEndTimestamp).toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Taipei' });
            timeInfoEl.textContent = `進食結束於 ${endHourDisplay}`;
        }


        // 進度條顯示 (斷食期和進食期都顯示已過時間)
        const progressPercent = Math.min(100, (timeSincePhaseStart / phaseDuration) * 100);
        setProgress(progressPercent);
        
        // Save state every minute for persistence
        if (seconds === 0 && minutes % 1 === 0) {
            saveState();
        }
    }

    function resetTimerDisplay() {
        clearInterval(timerInterval);
        isFasting = false;
        statusTextEl.textContent = '準備開始';
        statusTextEl.style.color = '#3f51b5';
        timerEl.textContent = '00:00:00';
        timeInfoEl.textContent = `模式: ${currentMode.fast}:${currentMode.eat}`;
        setProgress(0);
        startBtn.textContent = '開始斷食';
        startBtn.style.display = 'inline-block';
        stopBtn.style.display = 'none';
    }

    // --- User Actions ---
    // ✅ 實作編輯時間功能
    async function editTime() {
        if (!isFasting) {
            alert('請先開始斷食才能編輯時間！');
            return;
        }

        const currentStart = new Date(fastingState.start);
        const defaultDate = getFormattedDate(currentStart);
        const defaultTime = currentStart.toLocaleTimeString('zh-TW', { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Asia/Taipei' });
        
        const newDateStr = prompt(`請輸入新的斷食開始日期 (YYYY-MM-DD)：`, defaultDate);
        if (newDateStr === null) return; // 取消
        
        const newTimeStr = prompt(`請輸入新的斷食開始時間 (HH:MM)：`, defaultTime.substring(0, 5));
        if (newTimeStr === null) return; // 取消

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        // 1. 驗證日期格式和範圍
        const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
        if (!dateRegex.test(newDateStr)) {
            alert('日期格式錯誤，請使用 YYYY-MM-DD。');
            return;
        }
        
        // 2. 驗證時間格式
        const timeRegex = /^\d{2}:\d{2}$/;
        if (!timeRegex.test(newTimeStr)) {
            alert('時間格式錯誤，請使用 HH:MM。');
            return;
        }

        const [hourStr, minuteStr] = newTimeStr.split(':');
        const hour = parseInt(hourStr);
        const minute = parseInt(minuteStr);

        if (isNaN(hour) || isNaN(minute) || hour < 0 || hour > 23 || minute < 0 || minute > 59) {
            alert('時間數值無效。');
            return;
        }

        // 3. 計算新的開始時間戳記 (關鍵修正：確保時區和日期一起計算)
        // 使用 ISO 格式，但替換日期和時間部分，並確保以 TW 時區解析
        const [year, month, day] = newDateStr.split('-').map(Number);
        
        // 核心修正：創建一個 UTC 時間戳，但值是 TW 該日期時間的瞬間
        // month - 1 是因為月份從 0 開始
        const newStart = new Date(year, month - 1, day, hour, minute, 0);
        
        // 4. 驗證日期是否在未來
        if (newStart.getTime() > now.getTime() + TIME_OFFSET) { // 使用 now.getTime() + offset 作為 TW 的今天
            alert('無法將開始時間設定在未來日期或未來時間！');
            return;
        }

        // 更新狀態
        fastingState.start = newStart.getTime();
        await saveState();

        // 強制刷新計時器
        if (isFasting) {
             clearInterval(timerInterval);
             timerInterval = setInterval(updateTimer, 1000);
             updateTimer();
        }
        alert(`斷食開始時間已更新為 ${newDateStr} ${newTimeStr}！`);
    }

    function startFasting() {
        if (isFasting) return;
        
        // 紀錄斷食開始時間 (使用 UTC 時間戳)
        const now = Date.now();
        
        fastingState = {
            start: now, 
            mode: modeKey,
            status: 'fasting'
        };
        isFasting = true;
        saveState();
        
        startBtn.style.display = 'none';
        stopBtn.style.display = 'inline-block';
        
        timerInterval = setInterval(updateTimer, 1000);
        updateTimer();
    }

    function stopFasting() {
        if (!isFasting) return;
        
        clearInterval(timerInterval);
        isFasting = false;

        const end = Date.now();
        
        // 計算總時長
        const durationMs = end - fastingState.start;
        const totalHours = (durationMs / 3600000).toFixed(1);
        
        // 新增到歷史紀錄
        historyLog.push({
            date: getFormattedDate(fastingState.start),
            mode: fastingState.mode,
            start: fastingState.start,
            end: end,
            duration: totalHours + ' 小時'
        });
        
        // 清除當前狀態
        fastingState = {};
        saveState();
        
        renderHistory();
        resetTimerDisplay();
    }

    function updateMode() {
        modeKey = document.getElementById('fasting-mode').value;
        currentMode = modes[modeKey];
        if (!isFasting) {
             resetTimerDisplay();
        }
    }
    
    // ✅ Gemini LLM Feature 1: 獲取斷食後建議
    async function getFastingAdvice() {
        adviceBtn.disabled = true;
        adviceOutputEl.innerHTML = '<strong>✨ AI 正在分析您的斷食數據並生成建議...</strong>';

        const lastFast = historyLog.length > 0 ? historyLog[historyLog.length - 1] : null;
        
        if (!lastFast) {
            adviceOutputEl.innerHTML = '<strong>請先完成一次斷食，才能獲得個性化建議！</strong>';
            adviceBtn.disabled = false;
            return;
        }

        const prompt = `Act as a certified nutritionist and fasting coach. The user just completed an intermittent fasting period. The targeted mode was ${lastFast.mode} (fasting for ${modes[lastFast.mode].fast} hours). The actual total duration recorded was ${lastFast.duration}. Provide a concise, single-paragraph piece of advice (in Traditional Chinese) focused on the best foods to eat to safely break the fast and maximize nutrition, considering the total fasting hours.`;
        
        const apiKey = ""; 
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: {
                parts: [{ text: "You are a helpful nutritionist providing safe and effective advice." }]
            },
        };
        
        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '生成建議失敗，請稍後再試。';
            
            adviceOutputEl.innerHTML = `<strong>✨ 斷食後建議:</strong> ${text}`;
            
        } catch (error) {
            console.error("Gemini API Error:", error);
            adviceOutputEl.innerHTML = '<strong>✨ AI 服務連線失敗。請檢查網絡或稍後再試。</strong>';
        } finally {
            adviceBtn.disabled = false;
        }
    }
    
    // ✅ Gemini LLM Feature 2: 獲取斷食策略與激勵
    async function getMotivation() {
        motivationBtn.disabled = true;
        motivationOutputEl.innerHTML = '<strong>✨ AI 正在生成您的今日策略...</strong>';
        
        const goal = goalInputEl.value.trim();
        if (!goal) {
            motivationOutputEl.innerHTML = '<strong>請在輸入框中填寫您的今日斷食目標！</strong>';
            motivationBtn.disabled = false;
            return;
        }

        const mode = currentMode;
        const prompt = `Act as an encouraging fitness coach. The user is about to start ${mode.fast}:${mode.eat} intermittent fasting. The user's goal for this fast is: "${goal}". Provide a short, encouraging message and 3 specific, simple strategies (in numbered points, in Traditional Chinese) to help them get through the fasting window smoothly, focusing on hydration and mental focus, tailored to their goal.`;

        const apiKey = "";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{ parts: [{ text: prompt }] }],
            systemInstruction: {
                parts: [{ text: "You are an encouraging fitness coach. Use Traditional Chinese." }]
            },
        };

        try {
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '生成策略失敗，請稍後再試。';
            
            motivationOutputEl.innerHTML = `<strong>✨ 斷食策略與激勵:</strong><br>${text.replace(/\n/g, '<br>')}`;
        } catch (error) {
            console.error("Gemini API Error:", error);
            motivationOutputEl.innerHTML = '<strong>✨ AI 服務連線失敗。請檢查網絡或稍後再試。</strong>';
        } finally {
            motivationBtn.disabled = false;
        }
    }


    // --- Persistence ---
    async function loadState() {
        const state = await loadData('fastingState');
        const history = await loadData('fastingHistory');
        
        if (state && state.start && state.mode) {
            fastingState = state;
            isFasting = true;
            modeKey = state.mode;
            currentMode = modes[modeKey];
            
            document.getElementById('fasting-mode').value = modeKey;

            // 重新啟動計時器
            startBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            timerInterval = setInterval(updateTimer, 1000);
            updateTimer();
        }
        
        // 確保 historyLog 永遠是陣列
        if (history) {
            historyLog = Array.isArray(history) ? history : Object.values(history);
            renderHistory();
        }
    }

    function saveState() {
        // 儲存當前狀態和歷史記錄
        saveData('fastingState', fastingState);
        saveData('fastingHistory', historyLog);
    }
    
    // --- History Rendering ---
    function renderHistory() {
        historyTbody.innerHTML = '';
        
        // 確保 historyLog 是陣列
        if (!Array.isArray(historyLog) || historyLog.length === 0) {
            historyTbody.innerHTML = '<tr><td colspan="6">尚無紀錄...</td></tr>';
            return;
        }

        // 最新紀錄在前
        [...historyLog].reverse().forEach((log, index) => {
            const row = historyTbody.insertRow();
            const originalIndex = historyLog.length - 1 - index; 

            row.innerHTML = `
                <td>${log.date}</td>
                <td>${log.mode}</td>
                <td>${getFormattedTime(log.start)}</td>
                <td>${getFormattedTime(log.end)}</td>
                <td>${log.duration}</td>
                <td><button onclick="deleteHistory(${originalIndex})">刪除</button></td>
            `;
        });
    }
    
    async function deleteHistory(index) {
        if (confirm('確定要刪除這筆歷史紀錄嗎？')) {
            historyLog.splice(index, 1);
            await saveData('fastingHistory', historyLog);
            renderHistory();
        }
    }

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', () => {
        loadState();
        updateMode(); // 初始化模式顯示
    });
</script>
</body>
</html>
